<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Secure Hax Messenger üí¨üîê</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí¨</text></svg>">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff5aab">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Secure Hax">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="Secure Hax Messenger">
<meta name="description" content="–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏">
<meta name="keywords" content="messenger, secure, encrypted, chat, privacy, pwa">
<meta property="og:title" content="Secure Hax Messenger">
<meta property="og:description" content="–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º">
<meta property="og:type" content="website">
<meta property="og:image" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%23ff5aab' rx='100'/><text x='256' y='330' text-anchor='middle' font-size='256' fill='white'>üí¨</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --bg-color: linear-gradient(135deg, #2c003e, #5a006a, #ff5aab);
  --glass-bg: rgba(255, 255, 255, 0.1);
  --text-color: #f5f5f5;
  --header-color: #ffd6f7;
  --accent-color: #ff5aab;
  --button-gradient: linear-gradient(90deg, #ff5aab, #8a2be2);
  --success-color: #4CAF50;
  --mobile-breakpoint: 768px;
}

* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  user-select: none;
}

html {
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg-color);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: var(--text-color);
  margin:0; padding:0;
  transition: background 0.3s ease;
  position: relative;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

button, .btn, input, textarea, a, [role="button"] {
  touch-action: manipulation;
  min-height: 44px;
  min-width: 44px;
}

@media (hover: none) and (pointer: coarse) {
  button:hover, .card:hover, a:hover {
    transform: none !important;
    box-shadow: inherit !important;
    filter: none !important;
  }
  
  button:hover::before, .card:hover::before {
    opacity: 0 !important;
  }
}

.ripple { position: relative; overflow: hidden; }
.ripple::before {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 0; height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.3s, height 0.3s;
}
.ripple:active::before { width: 200px; height: 200px; }

#particle-canvas {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 1;
}

h1 { margin-top: 24px; font-size: 2rem; color: var(--header-color); text-shadow: 0 2px 8px rgba(0,0,0,0.5); z-index: 100; position: relative;}
.container { width: 90%; max-width: 800px; margin: 16px auto; padding-bottom: 120px; z-index: 100; position: relative;}
.card { 
  background: var(--glass-bg); 
  border-radius: 16px; 
  padding: 20px; 
  margin-bottom: 16px; 
  box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
  backdrop-filter: blur(4px); 
  transition: transform 0.4s, box-shadow 0.4s;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  top: -2px; left: -2px; right: -2px; bottom: -2px;
  background: linear-gradient(45deg, transparent, rgba(255,90,171,0.3), transparent);
  border-radius: 16px;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: -1;
}

.card:focus-visible::before { opacity: 1; }
.card:focus-visible { 
  transform: translateY(-2px); 
  box-shadow: 0 12px 24px rgba(0,0,0,0.6);
  outline: 2px solid rgba(255, 90, 171, 0.5);
  outline-offset: 2px;
}

@media (hover: none) and (pointer: coarse) {
  .card:active {
    transform: translateY(1px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.4);
  }
}

textarea, input { 
  width: 100%; 
  margin: 6px 0; 
  padding: 12px 16px; 
  border-radius: 10px; 
  border: none; 
  background: rgba(255,255,255,0.2); 
  color: #fff; 
  font-family: 'Roboto Mono', monospace; 
  font-size: 16px; 
  transition: all 0.6s;
  touch-action: manipulation;
  -webkit-appearance: none;
  appearance: none;
  min-height: 44px;
}

textarea:focus, input:focus { 
  outline: none; 
  background: rgba(255,255,255,0.25); 
  box-shadow: 0 0 15px rgba(255,90,171,0.5);
  border: 2px solid rgba(255,90,171,0.3);
}

textarea:active, input:active { background: rgba(255,255,255,0.3); }

#chat-input {
  position: relative;
  z-index: 10;
  margin: 0;
  padding: 12px 16px;
  min-height: 44px;
  font-size: 16px;
  border-radius: 25px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
}

button { 
  background: var(--button-gradient); 
  color: #fff; 
  border: none; 
  border-radius: 12px; 
  padding: 14px 20px; 
  margin: 4px; 
  cursor: pointer; 
  font-weight: 600; 
  transition: all 0.4s; 
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  touch-action: manipulation;
  min-height: 44px;
  min-width: 44px;
}

button:focus-visible { 
  outline: 2px solid rgba(255, 90, 171, 0.8);
  outline-offset: 2px;
  transform: translateY(-2px); 
  box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
  filter: brightness(1.1);
}

button:active { 
  transform: translateY(1px) scale(0.98);
  transition: all 0.3s;
}

@media (hover: none) and (pointer: coarse) {
  button:active {
    background: linear-gradient(90deg, #ff75c4, #a64ddb);
    transform: translateY(1px) scale(0.95);
  }
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  filter: none;
}

button, .choice-btn, .game-btn, #send-btn, #voice-btn, #theme-toggle {
  position: relative;
  overflow: hidden;
}

button::after, .choice-btn::after, .game-btn::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  transform: translate(-50%, -50%);
  transition: width 0.3s ease, height 0.3s ease;
  pointer-events: none;
}

button:active::after, .choice-btn:active::after, .game-btn:active::after {
  width: 200px;
  height: 200px;
}

.touch-active {
  transform: scale(0.95);
  filter: brightness(0.9);
  transition: all 0.1s ease;
}

.keyboard-open { var(--keyboard-height: 300px; }
.keyboard-open .container { padding-bottom: calc(80px + var(--keyboard-height, 0px) + env(safe-area-inset-bottom, 0px)); }
.keyboard-open .chat-input-area { transform: translateY(calc(-1 * var(--keyboard-height, 0px))); transition: transform 0.3s ease; }

:root {
  --keyboard-height: 0px;
  --safe-area-inset-bottom: 0px;
  --safe-area-inset-top: 0px;
  --safe-area-inset-left: 0px;
  --safe-area-inset-right: 0px;
}

@supports (padding: max(0px)) {
  :root {
    --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
    --safe-area-inset-top: env(safe-area-inset-top, 0px);
    --safe-area-inset-left: env(safe-area-inset-left, 0px);
    --safe-area-inset-right: env(safe-area-inset-right, 0px);
  }
}

@media (max-width: 768px) {
  button, .btn, [role="button"] { -webkit-user-select: none; user-select: none; }
  textarea, input, [contenteditable] { -webkit-user-select: text; user-select: text; }
}

@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  #sans-image { image-rendering: -webkit-optimize-contrast; image-rendering: crisp-edges; }
}

@media (prefers-color-scheme: dark) {
  .card { border: 1px solid rgba(255, 255, 255, 0.1); }
  input, textarea { border: 1px solid rgba(255, 255, 255, 0.1); }
}

.row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }

#chat-page { min-height: 60vh; }
#chat-page .card { margin-bottom: 20px; }

.chat-status {
  font-size: 0.9rem; color: var(--header-color);
  margin: 10px 0; padding: 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px; border-left: 4px solid var(--accent-color);
  text-align: center;
}

.typing-indicator {
  padding: 10px 15px; background: rgba(255,255,255,0.1);
  border-radius: 15px; align-self: flex-start;
  display: none; align-items: center; gap: 5px;
  animation: fadeIn 0.8s;
}
.typing-indicator.show { display: flex; }

.typing-dot {
  width: 8px; height: 8px; background: var(--accent-color);
  border-radius: 50%; animation: typingBounce 2.5s infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.5s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-10px); }
}

#chat-messages {
  min-height: 400px; max-height: 600px;
  overflow-y: auto; padding: 15px; padding-bottom: 100px;
  display: flex; flex-direction: column; gap: 10px;
  background: rgba(0,0,0,0.2); border-radius: 15px; margin: 15px 0;
}

.message {
  max-width: 80%; padding: 10px 15px;
  border-radius: 15px; word-wrap: break-word;
  animation: messageIn 1.0s;
}

@keyframes messageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.voice-player {
  display: flex; align-items: center; gap: 12px;
  padding: 8px; min-width: 200px; max-width: 280px; position: relative;
}

.voice-play-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(255,255,255,0.2); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; transition: all 0.4s; flex-shrink: 0;
}
.voice-play-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); }
.voice-play-btn:focus-visible { outline: 2px solid rgba(255, 90, 171, 0.8); outline-offset: 2px; transform: scale(1.05); }

@media (hover: none) and (pointer: coarse) {
  .voice-play-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.9); }
}
.voice-play-btn:active { transform: scale(0.95); }

.message.sent .voice-play-btn { background: rgba(0,0,0,0.3); }
.message.sent .voice-play-btn:hover { background: rgba(0,0,0,0.4); }

.voice-waveform {
  flex: 1; display: flex; align-items: center; gap: 2px; height: 32px; position: relative;
}

.voice-wave-bar {
  width: 3px; background: rgba(255,255,255,0.4); border-radius: 2px; transition: all 0.15s;
}
.message.sent .voice-wave-bar { background: rgba(255,255,255,0.6); }
.voice-wave-bar.active { background: rgba(255,255,255,0.9); }
.message.sent .voice-wave-bar.active { background: rgba(255,255,255,1); }

.voice-duration {
  font-size: 0.75rem; opacity: 0.7; font-family: 'Roboto Mono', monospace;
  min-width: 35px; text-align: right;
}

.voice-player audio { display: none; }

.message.sent {
  align-self: flex-end; background: linear-gradient(135deg, #ff5aab, #8a2be2);
  border-bottom-right-radius: 5px;
}
.message.received {
  align-self: flex-start; background: rgba(255,255,255,0.15);
  border-bottom-left-radius: 5px;
}
.message-time { font-size: 0.7rem; opacity: 0.6; margin-top: 3px; }

.chat-input-area {
  padding: 15px; border-top: 1px solid rgba(255,255,255,0.1);
  display: flex; gap: 10px; align-items: center;
}

#chat-input { flex: 1; margin: 0; }

#send-btn, #voice-btn, #video-call-btn {
  width: 50px; height: 50px; padding: 0; margin: 0;
  border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-size: 1.2rem;
}

#voice-btn { background: linear-gradient(135deg, #8a2be2, #ff5aab); }
#voice-btn.recording { background: #ff0000; animation: recordPulse 2s infinite; }

@keyframes recordPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.1); }
}

#room-setup {
  padding: 20px; text-align: center;
  background: rgba(255,255,255,0.05); border-radius: 15px; margin: 15px 0;
}

#room-code-display {
  font-family: 'Roboto Mono', monospace; font-size: 1.5rem; color: var(--accent-color);
  margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1);
  border-radius: 10px; cursor: pointer; transition: all 0.6s;
}
#room-code-display:hover { background: rgba(255,255,255,0.15); transform: scale(1.05); }

#menu-btn {
  position: fixed; top: 15px; left: 15px; z-index: 2000;
  min-width: 90px; height: 50px; font-size: 1.1rem; padding: 0 15px;
  border-radius: 25px; background: var(--glass-bg); backdrop-filter: blur(10px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4); color: var(--header-color);
  display: flex; align-items: center; justify-content: center;
}

#nav-menu {
  position: fixed; top: 70px; left: 15px; z-index: 1999;
  display: flex; flex-direction: column; gap: 10px; padding: 15px;
  background: var(--glass-bg); backdrop-filter: blur(10px);
  border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  transform: translateX(-150%); opacity: 0;
  transition: transform 0.6s ease-out, opacity 0.6s;
}
#nav-menu.active { transform: translateX(0); opacity: 1; }
#nav-menu button {
  width: 150px; padding: 10px 15px;
  background: rgba(255, 255, 255, 0.1); box-shadow: none; border-radius: 10px;
}
#nav-menu button.active { background: var(--button-gradient); }

.page { display: none; width: 100%; animation: fadeIn 0.8s; }
.page.active { display: block; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

#sans-container { position: relative; display: inline-block; }
#sans-image {
  width: 50px; height: 50px; cursor: pointer; border-radius: 50%;
  transition: all 0.6s; box-shadow: 0 0 10px rgba(255,255,255,0.3);
  animation: float 3s ease-in-out infinite;
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
#sans-image:hover {
  transform: scale(1.2) rotate(15deg); box-shadow: 0 0 20px rgba(255,90,171,0.8);
}
#sans-counter {
  position: absolute; top: -5px; right: -5px; background: #ff5aab;
  color: white; border-radius: 50%; width: 20px; height: 20px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: bold; opacity: 0; transition: opacity 0.3s;
}
#sans-counter.show { opacity: 1; }

#socks-message {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
  padding: 30px 50px; background: rgba(0,0,0,0.95); color: #fff000;
  font-size: 3rem; font-family: 'Roboto Mono', monospace; border: 5px solid #ff5aab;
  box-shadow: 0 0 50px #ff5aab; border-radius: 20px; z-index: 3500;
  opacity: 0; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  text-align: center; animation: rainbow 3s linear infinite;
}
#socks-message.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }

@keyframes rainbow {
  0% { border-color: #ff0000; } 16% { border-color: #ff7f00; }
  33% { border-color: #ffff00; } 50% { border-color: #00ff00; }
  66% { border-color: #0000ff; } 83% { border-color: #8b00ff; }
  100% { border-color: #ff0000; }
}

#confetti-container {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 3400; overflow: hidden;
}
.confetti {
  position: absolute; width: 10px; height: 10px; opacity: 0;
  animation-duration: 3s; animation-fill-mode: forwards;
  animation-timing-function: cubic-bezier(.17,.67,.83,.67);
}
@keyframes fall-left {
  0% { left: 0; top: 50%; transform: translate(-100%, -50%) rotate(0deg); opacity: 1; }
  100% { left: 50%; top: 100vh; transform: translate(-50%, 0) rotate(720deg); opacity: 0; }
}
@keyframes fall-right {
  0% { right: 0; top: 50%; transform: translate(100%, -50%) rotate(0deg); opacity: 1; }
  100% { right: 50%; top: 100vh; transform: translate(50%, 0) rotate(-720deg); opacity: 0; }
}

.socks-mode {
  background: linear-gradient(135deg, #ff69b4, #ff1493, #ff69b4) !important;
  animation: socksGradient 3s ease infinite !important; background-size: 200% 200% !important;
}
@keyframes socksGradient {
  0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; }
}

#toast-container { position: fixed; top:20px; right:20px; z-index:9999;}
.toast { 
  background: rgba(255,255,255,0.2); color: #fff; padding: 12px 18px; 
  margin-top: 8px; border-radius: 12px; box-shadow:0 4px 12px rgba(0,0,0,0.5); 
  backdrop-filter: blur(5px); font-weight:500; transition: all 0.6s; 
  opacity:0; transform: translateX(100px); border-left: 4px solid var(--accent-color);
}
.toast.show { opacity: 1; transform: translateX(0); }

footer {
  width:100%; text-align:center; margin:24px 0; padding-bottom: 20px;
  position: relative; z-index: 100; display: flex; flex-direction: column; align-items: center;
}
.footer-links { display: flex; justify-content: center; align-items: center; gap: 20px; }
a { 
  color: var(--accent-color); text-decoration: none; transition: all 0.4s;
  touch-action: manipulation; min-height: 44px; display: inline-flex; align-items: center;
}
a:focus-visible { 
  color: #fff; transform: scale(1.1);
  outline: 2px solid rgba(255, 90, 171, 0.8); outline-offset: 2px; border-radius: 4px;
}
@media (hover: none) and (pointer: coarse) {
  a:active {
    color: #fff; transform: scale(0.95); background: rgba(255, 90, 171, 0.1);
    padding: 4px 8px; border-radius: 6px;
  }
}

.rainbow-mode { animation: rainbowBg 5s linear infinite; }
@keyframes rainbowBg { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

.touch-friendly {
  min-height: 44px; min-width: 44px; padding: 12px 16px;
  touch-action: manipulation; cursor: pointer;
}
.voice-play-btn { touch-action: manipulation; min-width: 44px; min-height: 44px; border-radius: 50%; }
#menu-btn, #nav-menu button { touch-action: manipulation; min-height: 44px; }
.choice-btn, .game-btn { touch-action: manipulation; min-height: 48px; padding: 14px 24px; font-size: 1.1rem; }

@media (max-width: 768px) {
  h1 { font-size: 1.6rem; margin-top: 16px; padding-top: env(safe-area-inset-top, 0px); }
  .container {
    width: 95%; margin: 12px auto; padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
    padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right));
  }
  .card {
    padding: 16px; margin-bottom: 12px; border-radius: 12px; touch-action: manipulation;
  }
  #menu-btn {
    top: calc(10px + env(safe-area-inset-top, 0px)); left: calc(10px + env(safe-area-inset-left, 0px));
    min-width: 80px; height: 45px; font-size: 1rem; z-index: 2000;
  }
  #nav-menu {
    top: calc(60px + env(safe-area-inset-top, 0px)); left: calc(10px + env(safe-area-inset-left, 0px));
    padding: 12px; backdrop-filter: blur(15px);
  }
  #nav-menu button {
    width: 140px; padding: 12px 16px; min-height: 44px; touch-action: manipulation;
  }
  #chat-messages {
    padding: 12px; min-height: 300px; max-height: 50vh; -webkit-overflow-scrolling: touch;
  }
  .message { max-width: 85%; padding: 10px 14px; margin-bottom: 8px; }
  .chat-input-area {
    padding: 12px; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
    position: sticky; bottom: 0;
    padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right));
  }
  #chat-input {
    font-size: 16px; min-height: 44px; padding: 12px 16px;
    padding-bottom: max(12px, env(safe-area-inset-bottom, 0px));
  }
  #send-btn, #voice-btn, #video-call-btn {
    width: 48px; height: 48px; padding: 0; margin: 0;
    border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 1.2rem; touch-action: manipulation;
  }
  .room-status-indicator {
    position: fixed; top: calc(12px + env(safe-area-inset-top, 0px)); left: 50%;
    transform: translateX(-50%); z-index: 2001; display: flex; align-items: center;
    gap: 8px; background: var(--glass-bg); backdrop-filter: blur(15px);
    border-radius: 25px; padding: 8px 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    transition: all 0.3s ease; opacity: 0; pointer-events: none;
    padding-left: max(16px, calc(16px + env(safe-area-inset-left)));
    padding-right: max(16px, calc(16px + env(safe-area-inset-right)));
  }
  .room-status-indicator.show { opacity: 1; pointer-events: all; }
  .room-status-ball {
    width: 12px; height: 12px; border-radius: 50%; background: #ff5aab;
    animation: pulse 3s infinite; box-shadow: 0 0 8px rgba(255,90,171,0.6); flex-shrink: 0;
  }
  .room-status-ball.online { background: #4CAF50; box-shadow: 0 0 8px rgba(76,175,80,0.6); }
  .room-status-ball.offline { background: #f44336; box-shadow: 0 0 8px rgba(244,67,54,0.6); }
  .room-name {
    font-family: 'Roboto Mono', monospace; font-size: 0.9rem; color: var(--header-color); font-weight: 600;
  }
  .participants-count { font-size: 0.8rem; color: var(--text-color); opacity: 0.8; }
  footer {
    margin: 16px 0; padding-bottom: calc(30px + env(safe-area-inset-bottom, 0px));
    padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right);
  }
  .footer-links { gap: 15px; touch-action: manipulation; }
  #sans-image { width: 40px; height: 40px; touch-action: manipulation; min-height: 44px; min-width: 44px; }
  .page { -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
  #toast-container {
    top: calc(15px + env(safe-area-inset-top, 0px));
    right: max(15px, env(safe-area-inset-right, 0px));
    left: max(15px, env(safe-area-inset-left, 0px));
    z-index: 10000;
  }
  .toast { margin-top: 5px; touch-action: manipulation; padding: 14px 18px; min-height: 44px; display: flex; align-items: center; }
}

@media (max-width: 480px) {
  h1 { font-size: 1.4rem; padding-left: max(12px, env(safe-area-inset-left)); padding-right: max(12px, env(safe-area-inset-right)); }
  .container { width: 98%; margin: 8px auto; padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)); }
  .card { padding: 14px; border-radius: 10px; margin-bottom: 10px; }
  button { padding: 12px 16px; font-size: 0.95rem; min-height: 44px; }
  #send-btn, #voice-btn, #video-call-btn { width: 48px; height: 48px; font-size: 1.1rem; }
  #chat-input { font-size: 16px; padding: 12px 16px; padding-bottom: max(12px, env(safe-area-inset-bottom, 0px)); }
  .choice-btn, .game-btn { padding: 14px 20px; font-size: 1rem; min-height: 48px; min-width: 120px; }
  .room-status-indicator { padding: 6px 12px; border-radius: 20px; }
  .room-name { font-size: 0.85rem; }
  .participants-count { font-size: 0.75rem; }
  .voice-player { min-width: 180px; max-width: 250px; padding: 8px; }
  .voice-play-btn { width: 40px; height: 40px; min-width: 44px; min-height: 44px; }
  #sans-container { display: flex; align-items: center; justify-content: center; padding: 8px; }
  #sans-image { width: 44px; height: 44px; min-width: 44px; min-height: 44px; }
}

.desktop-device .container { padding-bottom: 140px; }
.desktop-device #chat-messages { padding-bottom: 120px; max-height: 500px; }
.desktop-device .chat-input-area {
  position: static !important; padding: 20px;
  background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.1);
  border-radius: 0 0 15px 15px;
}
.desktop-device.keyboard-open .chat-input-area { transform: none !important; }
.desktop-device .chat-input-area:hover { background: rgba(0,0,0,0.25); }
.desktop-device button:hover, .desktop-device .card:hover { transform: translateY(-2px); transition: all 0.6s; }

.mobile-device .chat-input-area {
  position: sticky; bottom: 0; padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
  background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
}

#theme-toggle {
  width: 50px; height: 50px; border-radius: 50%; font-size: 1.2rem;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 4px 20px rgba(255,90,171,0.5); background: var(--button-gradient);
  transition: all 0.6s; border: none; cursor: pointer; color: white;
}
#theme-toggle:hover { transform: translateY(-3px) scale(1.1); box-shadow: 0 8px 25px rgba(255,90,171,0.7); }
#theme-toggle:focus-visible { outline: 2px solid rgba(255, 90, 171, 0.8); outline-offset: 2px; transform: translateY(-2px) scale(1.05); }

.hacker-theme {
  --bg-color: linear-gradient(180deg, #000000, #0a0a0a, #001a00);
  --glass-bg: rgba(0, 20, 0, 0.7);
  --text-color: #00ff41;
  --header-color: #00ff41;
  --accent-color: #00ff41;
  --button-gradient: linear-gradient(90deg, #003300, #00ff41);
  --success-color: #00ff41;
}
.hacker-theme body { background: var(--bg-color); color: var(--text-color); }
.hacker-theme .card, .hacker-theme .room-status-indicator, .hacker-theme #nav-menu,
.hacker-theme #menu-btn, .hacker-theme #theme-toggle {
  background: var(--glass-bg); backdrop-filter: blur(15px);
  border: 1px solid rgba(0, 255, 65, 0.4); box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
}
.hacker-theme h1, .hacker-theme h2, .hacker-theme h3, .hacker-theme .room-name, .hacker-theme .participants-count {
  color: var(--header-color); text-shadow: 0 0 15px rgba(0, 255, 65, 0.8), 0 0 30px rgba(0, 255, 65, 0.4);
  font-family: 'Roboto Mono', monospace;
}
.hacker-theme button {
  background: var(--button-gradient); color: #000;
  border: 1px solid var(--accent-color); box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
  font-family: 'Roboto Mono', monospace; font-weight: 700;
}
.hacker-theme button:hover { box-shadow: 0 0 30px rgba(0, 255, 65, 0.6); filter: brightness(1.3); }
.hacker-theme input, .hacker-theme textarea {
  background: rgba(0, 20, 0, 0.6); border: 1px solid rgba(0, 255, 65, 0.5);
  color: var(--text-color); font-family: 'Roboto Mono', monospace;
}
.hacker-theme input:focus, .hacker-theme textarea:focus {
  background: rgba(0, 30, 0, 0.8); box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); outline: none;
}
.hacker-theme .message.sent {
  background: linear-gradient(135deg, #003300, #005500); border: 1px solid rgba(0, 255, 65, 0.3);
}
.hacker-theme .message.received {
  background: rgba(0, 20, 0, 0.8); border: 1px solid rgba(0, 255, 65, 0.2);
}

.hacker-theme::before {
  content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-image: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 65, 0.03) 3px),
                    repeating-linear-gradient(90deg, rgba(0, 255, 65, 0.03) 0px, transparent 1px, transparent 2px, rgba(0, 255, 65, 0.03) 3px);
  z-index: 0; opacity: 0.3; pointer-events: none;
}
.hacker-theme::after {
  content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.4) 100%);
  z-index: 0; pointer-events: none;
}

@keyframes matrix-rain { 0% { transform: translateY(-100%); } 100% { transform: translateY(100vh); } }

.game-modal {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.8); z-index: 5000; backdrop-filter: blur(5px);
}
.game-modal.active { display: flex; align-items: center; justify-content: center; }

.game-content {
  background: var(--glass-bg); border-radius: 20px; padding: 0;
  max-width: 500px; width: 90%; max-height: 90%; overflow: hidden;
  backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.game-header {
  display: flex; justify-content: space-between; align-items: center; padding: 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(255, 255, 255, 0.05);
}
.game-header h3 { margin: 0; color: var(--header-color); }

.close-game {
  width: 35px; height: 35px; border-radius: 50%; background: rgba(255, 255, 255, 0.1);
  border: none; color: var(--text-color); cursor: pointer; transition: all 0.6s;
}
.close-game:hover { background: rgba(255, 90, 171, 0.5); transform: scale(1.1); }

.game-body { padding: 30px; text-align: center; }

.game-status {
  font-size: 1.2rem; margin-bottom: 20px; padding: 15px;
  background: rgba(255, 255, 255, 0.1); border-radius: 10px; border-left: 4px solid var(--accent-color);
}
.round-info, .score-info { font-size: 1.1rem; margin: 15px 0; font-weight: 600; }

.game-choices { display: flex; gap: 15px; justify-content: center; margin: 25px 0; flex-wrap: wrap; }
.choice-btn {
  padding: 15px 25px; border: 2px solid var(--accent-color);
  background: rgba(255, 255, 255, 0.1); color: var(--text-color); border-radius: 15px;
  cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: all 0.6s; min-width: 120px;
}
.choice-btn:hover {
  background: var(--button-gradient); color: #fff; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}
@media (hover: none) and (pointer: coarse) {
  .choice-btn:active { background: var(--button-gradient); color: #fff; transform: translateY(1px) scale(0.95); }
}
.choice-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.game-actions { display: flex; gap: 15px; justify-content: center; margin: 25px 0; flex-wrap: wrap; }
.game-btn {
  padding: 12px 24px; border: none; border-radius: 12px; font-size: 1.1rem;
  font-weight: 600; cursor: pointer; transition: all 0.6s; min-width: 120px;
}
.game-btn.primary { background: var(--button-gradient); color: #fff; }
.game-btn.secondary { background: rgba(255, 255, 255, 0.2); color: var(--text-color); border: 2px solid rgba(255, 255, 255, 0.3); }
.game-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
@media (hover: none) and (pointer: coarse) { .game-btn:active { transform: translateY(1px) scale(0.95); } }

.timer {
  margin-top: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 10px;
  padding: 15px; position: relative; overflow: hidden;
}
.timer-bar {
  height: 8px; background: linear-gradient(90deg, var(--accent-color), #ff5aab);
  border-radius: 4px; transition: width 1s linear; width: 100%;
}
.timer-text {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  font-weight: bold; color: var(--text-color); background: rgba(0, 0, 0, 0.7);
  padding: 5px 10px; border-radius: 5px;
}

.homepage-images { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
.homepage-image {
  width: 100%; height: 150px; object-fit: cover; border-radius: 15px;
  transition: all 0.6s; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}
.homepage-image:hover { transform: scale(1.05); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4); }
@media (hover: none) and (pointer: coarse) { .homepage-image:active { transform: scale(0.98); transition: transform 0.3s ease; } }

@media (max-width: 768px) {
  #theme-toggle { width: 45px; height: 45px; font-size: 1.1rem; }
  .game-content { width: 95%; margin: 20px; }
  .game-body { padding: 20px; }
  .game-choices { flex-direction: column; align-items: center; }
  .choice-btn { width: 100%; max-width: 200px; }
  .game-actions { flex-direction: column; align-items: center; }
  .game-btn { width: 100%; max-width: 200px; }
  .homepage-images { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
  .homepage-image { height: 120px; }
}

@media (max-width: 480px) {
  #theme-toggle { width: 40px; height: 40px; font-size: 1rem; }
  .homepage-images { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .homepage-image { height: 100px; }
}

body::after {
  content: ''; position: fixed; bottom: 0; left: 0; right: 0; height: 300px;
  background: radial-gradient(ellipse at bottom, rgba(255, 90, 171, 0.3) 0%, transparent 70%);
  pointer-events: none; z-index: 0; opacity: 0.6;
}
.hacker-theme body::after { background: radial-gradient(ellipse at bottom, rgba(0, 255, 65, 0.2) 0%, transparent 70%); }

.scroll-reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
.scroll-reveal.revealed { opacity: 1; transform: translateY(0); }
.scroll-reveal:nth-child(1) { transition-delay: 0.3s; }
.scroll-reveal:nth-child(2) { transition-delay: 0.5s; }
.scroll-reveal:nth-child(3) { transition-delay: 0.3s; }
.scroll-reveal:nth-child(4) { transition-delay: 0.4s; }
.scroll-reveal:nth-child(5) { transition-delay: 0.5s; }
.scroll-reveal:nth-child(6) { transition-delay: 0.6s; }
.scroll-reveal-left { opacity: 0; transform: translateX(-50px); transition: opacity 0.7s ease-out, transform 0.7s ease-out; }
.scroll-reveal-left.revealed { opacity: 1; transform: translateX(0); }
.scroll-reveal-right { opacity: 0; transform: translateX(50px); transition: opacity 0.7s ease-out, transform 0.7s ease-out; }
.scroll-reveal-right.revealed { opacity: 1; transform: translateX(0); }
.scroll-reveal-scale { opacity: 0; transform: scale(0.9); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
.scroll-reveal-scale.revealed { opacity: 1; transform: scale(1); }

@media (max-width: 768px) {
  * { animation-duration: 0.5s !important; transition-duration: 0.2s !important; }
  .card, button, .choice-btn, .game-btn { transition: transform 0.15s ease; }
  .page { animation: fadeIn 0.3s ease-out; }
}

body { overscroll-behavior: contain; }
.page { overscroll-behavior: contain; }

@media (max-width: 768px) {
  #chat-messages { -webkit-overflow-scrolling: touch; scroll-behavior: smooth; overscroll-behavior: contain; }
}

@media (max-width: 768px) and (orientation: landscape) {
  .container { padding-bottom: calc(60px + env(safe-area-inset-bottom, 0px)); }
  #chat-messages { max-height: 40vh; }
  .card { padding: 12px; }
  h1 { font-size: 1.4rem; margin-top: 8px; }
}

@media (min-width: 1200px) { .container { max-width: 900px; } .card { padding: 24px; } }

@media print {
  .card { background: white !important; color: black !important; box-shadow: none !important; }
  button, #menu-btn, #nav-menu, footer { display: none !important; }
}

.loading { opacity: 0.7; pointer-events: none; transition: opacity 0.3s ease; }
.loading::after {
  content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
  margin: -10px 0 0 -10px; border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: white; border-radius: 50%; animation: spin 1.5s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.touch-capable button:focus:not(:focus-visible) { outline: none; }
.no-touch button:hover, .no-touch .choice-btn:hover, .no-touch .game-btn:hover {
  background: linear-gradient(90deg, #ff75c4, #a64ddb); transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.5); filter: brightness(1.1);
}
.no-touch .card:hover::before { opacity: 1; }
.no-touch .card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.6); }
.no-touch a:hover { color: #fff; transform: scale(1.1); }

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
}
@media (prefers-contrast: high) {
  .card { border: 2px solid var(--accent-color); }
  button { border: 2px solid rgba(255, 255, 255, 0.3); }
}

*:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; }

.skip-link {
  position: absolute; top: -40px; left: 6px; background: var(--accent-color);
  color: white; padding: 8px; text-decoration: none; border-radius: 4px; z-index: 10000;
}
.skip-link:focus { top: 6px; }

/* ============ VIDEO CALL STYLES ============ */
.call-content {
  width: 100%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;
  background: #000 !important;
}
.call-body { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
.video-container {
  flex: 1; position: relative; background: #1a1a1a; display: flex; align-items: center; justify-content: center;
}
#remote-video { width: 100%; height: 100%; object-fit: cover; }
#local-video {
  position: absolute; bottom: 20px; right: 20px; width: 120px; height: 160px;
  background: #333; border: 2px solid var(--accent-color); border-radius: 10px;
  object-fit: cover; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
}
#call-status-text {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  color: white; font-size: 1.2rem; z-index: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
}
.call-controls {
  padding: 20px; display: flex; justify-content: center; gap: 20px;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
}
.control-btn {
  width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem;
  cursor: pointer; background: rgba(255,255,255,0.2); color: white; transition: all 0.3s;
}
.control-btn:hover { transform: scale(1.1); }
.control-btn.active { background: rgba(255,255,255,0.2); }
.control-btn:not(.active) { background: #f44336; position: relative; }
.control-btn:not(.active)::after {
  content: '/'; position: absolute; font-size: 2rem;
  left: 50%; top: 50%; transform: translate(-50%, -50%);
}
.control-btn.hangup { background: #f44336; transform: rotate(135deg); }
.control-btn.hangup:hover { background: #d32f2f; }
#video-call-btn {
  width: 50px; height: 50px; border-radius: 50%; font-size: 1.2rem;
  background: linear-gradient(135deg, #00c6ff, #0072ff); margin-left: 5px;
}
@media (max-width: 768px) {
  #local-video { width: 90px; height: 120px; bottom: 90px; }
  .call-content { height: 100%; max-height: 100%; border-radius: 0; }
}
</style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<button id="menu-btn">‚â° Menu</button>

<div class="room-status-indicator" id="room-status-indicator">
  <div class="room-status-ball" id="room-status-ball"></div>
  <div class="room-info">
    <div class="room-name" id="room-name">No Room</div>
    <div class="participants-count" id="participants-count">0 participants</div>
  </div>
</div>

<div id="game-modal" class="game-modal">
  <div class="game-content">
    <div class="game-header">
      <h3 id="game-title">–ò–≥—Ä–∞ –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞</h3>
      <button class="close-game" id="close-game-btn">‚úñ</button>
    </div>
    <div class="game-body">
      <div id="game-status"></div>
      <div class="round-info">–†–∞—É–Ω–¥: <span id="current-round">1</span> / 3</div>
      <div class="score-info">
        <span id="my-score">–í–∞—à —Å—á–µ—Ç: 0</span> |
        <span id="opponent-score">–°—á–µ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞: 0</span>
      </div>
      <div class="game-choices" id="game-choices">
        <button class="choice-btn" data-choice="rock">ü™® –ö–∞–º–µ–Ω—å</button>
        <button class="choice-btn" data-choice="paper">üìÑ –ë—É–º–∞–≥–∞</button>
        <button class="choice-btn" data-choice="scissors">‚úÇÔ∏è –ù–æ–∂–Ω–∏—Ü—ã</button>
      </div>
      <div class="game-actions">
        <button id="accept-game-btn" class="game-btn primary">–ò–≥—Ä–∞—Ç—å!</button>
        <button id="decline-game-btn" class="game-btn secondary">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        <button id="play-again-btn" class="game-btn primary" style="display:none;">–°—ã–≥—Ä–∞—Ç—å –µ—â—ë</button>
      </div>
      <div class="timer">
        <div class="timer-bar" id="timer-bar"></div>
        <div class="timer-text">–í—Ä–µ–º—è: <span id="timer-count">10</span>—Å</div>
      </div>
    </div>
  </div>
</div>

<nav id="nav-menu">
  <button data-page="home" class="active">üè† –ì–ª–∞–≤–Ω–∞—è</button>
  <button data-page="chat">üí¨ –ß–∞—Ç</button>
  <button data-page="setup">üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞</button>
</nav>

<div class="container">
  <div id="chat-page" class="page">
    <h1>üí¨ Secure Chat</h1>
    
    <div class="card">
      <div class="chat-status" id="chat-status">üîí –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
    </div>
    
    <div class="card" id="room-setup">
    <h4>–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</h4>
    <button id="create-room-btn">üÜï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    <div style="margin: 15px 0;">‚Äî –∏–ª–∏ ‚Äî</div>
    <input type="text" id="join-room-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã..." maxlength="20">
    <button id="join-room-btn">üö™ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      
      <div id="room-code-display" style="display:none;"></div>
    </div>
    
    <div class="card" id="chat-messages" style="display:none;">
      <div class="typing-indicator" id="typing-indicator">
        <span style="font-size: 0.85rem;">–ü–µ—á–∞—Ç–∞–µ—Ç</span>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
    
    <div class="card chat-input-area" style="display:none;" id="chat-input-area">
      <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="video-call-btn" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">üìπ</button>
      <button id="voice-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">üé§</button>
      <button id="send-btn">üì§</button>
    </div>
  </div>
  <div id="home-page" class="page active">
    <h1>Secure Hax Messenger üí¨üîê</h1>

    <div id="socks-message">üß¶ SOCKS MODE! üß¶</div>
    <div id="confetti-container"></div>

    <div class="card scroll-reveal" style="text-align: center;">
      <h2>üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±—É–¥—É—â–µ–µ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤!</h2>
      <div class="homepage-images">
        <img src="https://images.unsplash.com/photo-1614064641938-3bbee52942c7?w=300&h=150&fit=crop" alt="Cybersecurity" class="homepage-image">
        <img src="https://images.unsplash.com/photo-1550751827-4bd374c3f58b?w=300&h=150&fit=crop" alt="Encrypted Communication" class="homepage-image">
        <img src="https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?w=300&h=150&fit=crop" alt="Modern Interface" class="homepage-image">
      </div>
      <p style="text-align: left;">
        <strong>Secure Hax Messenger</strong> ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —á–∞—Ç. –≠—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å <strong>–≤–æ–µ–Ω–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</strong>, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä—è–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ!
      </p>
      <div style="margin: 20px 0; padding: 15px; background: rgba(255,90,171,0.1); border-radius: 10px; border-left: 4px solid var(--accent-color);">
        <strong>üîí –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?</strong><br>
        –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è <strong>end-to-end</strong> —Å –ø–æ–º–æ—â—å—é TweetNaCl. –î–∞–∂–µ —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–∏–¥–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∞—à–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π!
      </div>
    </div>

    <div class="card scroll-reveal">
      <h2>‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</h2>
      <div style="display: grid; gap: 15px; margin-top: 15px;">
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>üîê End-to-End —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ</strong><br>
          <small>–í–∞—à–∏ –∫–ª—é—á–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ. –ù–∏–∫—Ç–æ –Ω–µ –∏–º–µ–µ—Ç –∫ –Ω–∏–º –¥–æ—Å—Ç—É–ø–∞.</small>
        </div>
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</strong><br>
          <small>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è Firebase Realtime Database –¥–ª—è –æ–±–º–µ–Ω–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.</small>
        </div>
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>üìπ –í–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏</strong><br>
          <small>–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏ P2P —á–µ—Ä–µ–∑ WebRTC.</small>
        </div>
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>üëÄ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏</strong><br>
          <small>–í–∏–¥–∏—Ç–µ –∫–æ–≥–¥–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–µ—á–∞—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–∞–∫ –≤ Telegram!).</small>
        </div>
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</strong><br>
          <small>–ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º!</small>
        </div>
        <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
          <strong>üé® –ö—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</strong><br>
          <small>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ –∏ —Å–ø–µ—Ü—ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.</small>
        </div>
      </div>
    </div>

    <div class="card scroll-reveal">
      <h2>üöÄ –ö–∞–∫ –Ω–∞—á–∞—Ç—å?</h2>
      <ol style="text-align: left; line-height: 2; font-size: 1.05rem;">
        <li><strong>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É üí¨ –ß–∞—Ç</strong> –≤ –º–µ–Ω—é</li>
        <li><strong>–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É</strong> ‚Äî –ø–æ–ª—É—á–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: HAX-A1B2C3)</li>
        <li><strong>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º</strong> —Å –¥—Ä—É–≥–æ–º –ª—é–±—ã–º —Å–ø–æ—Å–æ–±–æ–º</li>
        <li><strong>–î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</strong> ‚Äî —É–≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!"</li>
        <li><strong>–û–±—â–∞–π—Ç–µ—Å—å –±–µ–∑–æ–ø–∞—Å–Ω–æ!</strong> –¢–µ–∫—Å—Ç–æ–≤—ã–µ, –≥–æ–ª–æ—Å–æ–≤—ã–µ –∏ –≤–∏–¥–µ–æ—Å–æ–æ–±—â–µ–Ω–∏—è üîê</li>
      </ol>
    </div>

    <div class="card scroll-reveal">
      <h2>üõ°Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h2>
      <p style="text-align: left; line-height: 1.8;">
        <strong>TweetNaCl</strong> ‚Äî –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞.<br>
        <strong>WebRTC</strong> ‚Äî –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∏.<br>
        <strong>Firebase Realtime Database</strong> ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è.<br>
        <strong>Client-side only</strong> ‚Äî –≤–µ—Å—å –∫–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
      </p>
    </div>

    <div class="card scroll-reveal" style="background: rgba(255,90,171,0.1); border: 2px solid var(--accent-color);">
      <h2>‚ö†Ô∏è –í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å</h2>
      <ul style="text-align: left; line-height: 1.8;">
        <li>–°–æ–æ–±—â–µ–Ω–∏—è <strong>–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</strong> –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–º–Ω–∞—Ç—ã</li>
        <li>–û–¥–∏–Ω –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã = <strong>–æ–¥–Ω–∞ –ø–∞—Ä–∞</strong> —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤</li>
        <li>–ù–µ –¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∫–æ–º–Ω–∞—Ç—ã –ø—É–±–ª–∏—á–Ω–æ</li>
        <li>–•—Ä–∞–Ω–∏—Ç–µ —Å–≤–æ–∏ –∫–ª—é—á–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>
        <li>–≠—Ç–æ <strong>beta-–≤–µ—Ä—Å–∏—è</strong> ‚Äî –≤–æ–∑–º–æ–∂–Ω—ã –±–∞–≥–∏</li>
      </ul>
    </div>

    <div class="card scroll-reveal">
      <h2>üé≠ –ü–∞—Å—Ö–∞–ª–∫–∏</h2>
      <p style="text-align: left; color: var(--header-color);">
        üíÄ –ö–ª–∏–∫–Ω–∏ –Ω–∞ <strong>Sans</strong> –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã 3 —Ä–∞–∑–∞...<br>
        üß¶ –í–≤–µ–¥–∏ —Å–ª–æ–≤–æ "<strong>socks</strong>" –≤ —á–∞—Ç–µ...<br>
        üéµ –ò—Å—Å–ª–µ–¥—É–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî –Ω–∞–π–¥—ë—à—å –µ—â—ë —Å—é—Ä–ø—Ä–∏–∑—ã!
      </p>
    </div>
  </div>

  <section id="setup-page" class="page">
    <h1>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–µ–π</h1>

    <div class="card">
      <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π</h2>
      <p>–ö–ª—é—á–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã.</p>
      <button id="manual-gen">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
      
      <div id="key-info" style="margin-top: 15px; display:none;">
        <label>–í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:</label>
        <textarea id="pub-key-display" rows="3" readonly></textarea>
        <small style="opacity:0.7;">–û—Ç–ø–µ—á–∞—Ç–æ–∫: <code id="key-fp">N/A</code></small>
      </div>
    </div>
  </section>
</div>

<div id="call-modal" class="game-modal">
  <div class="game-content call-content">
    <div class="game-header">
      <h3>üìû Secure Call</h3>
    </div>
    <div class="call-body">
      <div class="video-container">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div id="call-status-text">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
      </div>
      
      <div class="call-controls">
        <button id="toggle-mic-btn" class="control-btn active">üé§</button>
        <button id="toggle-cam-btn" class="control-btn active">üì∑</button>
        <button id="hangup-btn" class="control-btn hangup">üìû</button>
      </div>
    </div>
  </div>
</div>

<div id="incoming-call-modal" class="game-modal">
  <div class="game-content" style="max-width: 300px; text-align: center;">
    <h3>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!</h3>
    <p>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã–∑—ã–≤–∞–µ—Ç –≤–∞—Å...</p>
    <div class="game-actions">
      <button id="answer-call-btn" class="game-btn primary" style="background: #4CAF50;">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
      <button id="reject-call-btn" class="game-btn secondary" style="background: #f44336; border:none; color:white;">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<footer>
  <div class="footer-links">
    <div id="sans-container">
      <img id="sans-image"
           src="https://avatanplus.com/files/resources/mid/57b39ece5502b15695a4560c.png">
      <div id="sans-counter">0</div>
    </div>
    <button id="theme-toggle">üé®</button>
    <a href="https://t.me/bluzn" target="_blank" title="Telegram">
      <i class="fab fa-telegram fa-2x"></i>
    </a>
  </div>
  <small style="margin-top: 10px;">
    ¬© 2025 Secure Hax Inc. | Made with üíú by –ë–ª—é–∑
  </small>
</footer>

<script src="nacl.min.js"></script>
<script src="nacl-util.min.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, push, serverTimestamp, onDisconnect, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyCmC_cXIvvA4EPAezjzsInBf_Ng-V4jwfk",
  authDomain: "hxchatt.firebaseapp.com",
  databaseURL: "https://hxchatt-default-rtdb.firebaseio.com",
  projectId: "hxchatt",
  storageBucket: "hxchatt.firebasestorage.app",
  messagingSenderId: "382150861330",
  appId: "1:382150861330:web:ab20a639246cd48bac6ecb"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ============ STATE ============
const state = {
  activePage: 'home',
  sansClicks: 0,
  socksMode: false,
  rainbowMode: false,
  myKeyPair: null,
  peerPublicKey: null,
  roomId: null,
  userId: 'user_' + Math.random().toString(36).substr(2, 9),
  isHost: false,
  isMobile: isMobileDevice(),
  participants: 0,
  peerOnline: false,
  peerLeft: false,
  currentTheme: 'normal',
  gameState: {
    active: false,
    isHost: false,
    round: 1,
    myScore: 0,
    opponentScore: 0,
    myChoice: null,
    opponentChoice: null,
    timeLeft: 10,
    timer: null,
    waitingForAccept: false,
    waitingForChoice: false
  }
};

// –£–º–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function isMobileDevice() {
  const userAgent = navigator.userAgent.toLowerCase();
  const mobileKeywords = ['mobile', 'android', 'iphone', 'ipad', 'phone', 'tablet'];
  const isMobileUA = mobileKeywords.some(keyword => userAgent.includes(keyword));
  const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const isSmallScreen = window.innerWidth <= 768;
  const isPortrait = window.innerHeight >= window.innerWidth;
  
  return isMobileUA || (hasTouch && isSmallScreen && isPortrait);
}

function checkMobile() {
  state.isMobile = isMobileDevice();
  document.body.classList.toggle('mobile-device', state.isMobile);
  document.body.classList.toggle('desktop-device', !state.isMobile);
  
  if (state.isMobile && state.roomId) {
    const indicator = document.getElementById('room-status-indicator');
    if (indicator) indicator.classList.add('show');
  } else {
    const indicator = document.getElementById('room-status-indicator');
    if (indicator) indicator.classList.remove('show');
  }
}

function updateRoomStatus() {
  const indicator = document.getElementById('room-status-indicator');
  const statusBall = document.getElementById('room-status-ball');
  const roomName = document.getElementById('room-name');
  const participantsCount = document.getElementById('participants-count');
  
  if (!state.roomId) {
    indicator.classList.remove('show');
    return;
  }
  
  roomName.textContent = state.roomId;
  statusBall.className = 'room-status-ball';
  if (state.peerLeft) {
    statusBall.classList.add('offline');
  } else if (state.peerOnline) {
    statusBall.classList.add('online');
  } else {
    statusBall.classList.add('offline');
  }
  
  const count = state.peerOnline ? 2 : (state.peerLeft ? 1 : 1);
  participantsCount.textContent = `${count} participant${count !== 1 ? 's' : ''}`;
  
  if (state.isMobile) {
    indicator.classList.add('show');
  }
}

function showRoomStatus() { updateRoomStatus(); }

const themeToggle = document.getElementById('theme-toggle');

function toggleTheme() {
  if (state.currentTheme === 'normal') {
    document.body.classList.add('hacker-theme');
    state.currentTheme = 'hacker';
    themeToggle.innerHTML = 'üå∏';
    showToast('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ —Ö–∞–∫–µ—Ä—Å–∫—É—é —Ç–µ–º—É! üñ§');
    localStorage.setItem('haxTheme', 'hacker');
  } else {
    document.body.classList.remove('hacker-theme');
    state.currentTheme = 'normal';
    themeToggle.innerHTML = 'üé®';
    showToast('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ –æ–±—ã—á–Ω—É—é —Ç–µ–º—É!');
    localStorage.setItem('haxTheme', 'normal');
  }
}

function loadTheme() {
  const savedTheme = localStorage.getItem('haxTheme');
  if (savedTheme === 'hacker') {
    document.body.classList.add('hacker-theme');
    state.currentTheme = 'hacker';
    themeToggle.innerHTML = 'üå∏';
  } else {
    state.currentTheme = 'normal';
    themeToggle.innerHTML = 'üé®';
  }
}

themeToggle.addEventListener('click', toggleTheme);

const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const particles = [];
for(let i = 0; i < 50; i++) {
  particles.push({
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    vx: (Math.random() - 0.5) * 0.5,
    vy: (Math.random() - 0.5) * 0.5,
    size: Math.random() * 2 + 1
  });
}

function animateParticles() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  particles.forEach(p => {
    p.x += p.vx;
    p.y += p.vy;
    if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
    if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  requestAnimationFrame(animateParticles);
}
animateParticles();

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  setTimeout(() => { checkMobile(); }, 100);
});

const pages = document.querySelectorAll('.page');
const navButtons = document.querySelectorAll('#nav-menu button');
const menuBtn = document.getElementById('menu-btn');
const navMenu = document.getElementById('nav-menu');

function toggleMenu() {
  navMenu.classList.toggle('active');
  menuBtn.innerHTML = navMenu.classList.contains('active') ? '‚úñ Close' : '‚â° Menu';
}

menuBtn.addEventListener('click', toggleMenu);

function showPage(pageId) {
  state.activePage = pageId;
  pages.forEach(p => p.classList.remove('active'));
  navButtons.forEach(b => {
    b.classList.remove('active');
    if(b.getAttribute('data-page') === pageId) b.classList.add('active');
  });
  const page = document.getElementById(pageId + '-page');
  if(page) page.classList.add('active');
}

navButtons.forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    showPage(e.target.getAttribute('data-page'));
    toggleMenu();
  });
});

let mediaRecorder = null;
let audioChunks = [];
let isRecording = false;

const voiceBtn = document.getElementById('voice-btn');

voiceBtn.addEventListener('click', async () => {
  if (!state.roomId || !state.peerPublicKey) {
    showToast('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ!');
    return;
  }
  
  if (!isRecording) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = (event) => { audioChunks.push(event.data); };
      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        await sendVoiceMessage(audioBlob);
        stream.getTracks().forEach(track => track.stop());
      };
      mediaRecorder.start();
      isRecording = true;
      voiceBtn.classList.add('recording');
      voiceBtn.textContent = '‚èπÔ∏è';
      showToast('üé§ –ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
    } catch(err) {
      console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
      showToast('–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    }
  } else {
    mediaRecorder.stop();
    isRecording = false;
    voiceBtn.classList.remove('recording');
    voiceBtn.textContent = 'üé§';
  }
});

async function sendVoiceMessage(audioBlob) {
  try {
    showToast('‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è...');
    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    reader.onloadend = async () => {
      const base64Audio = reader.result;
      const encrypted = encryptMessage(`[VOICE]:${base64Audio}`);
      const messageRef = push(ref(db, `rooms/${state.roomId}/messages`));
      await set(messageRef, {
        sender: state.userId,
        ciphertext: encrypted,
        type: 'voice',
        timestamp: serverTimestamp()
      });
      showToast('‚úÖ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
    };
  } catch(err) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', err);
    showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
  }
}

const sansImg = document.getElementById('sans-image');
const sansCounter = document.getElementById('sans-counter');
const socksMsg = document.getElementById('socks-message');
const confettiContainer = document.getElementById('confetti-container');

sansImg.addEventListener('click', () => {
  if(state.activePage !== 'home') return;
  state.sansClicks++;
  sansCounter.textContent = state.sansClicks;
  sansCounter.classList.add('show');
  if(state.sansClicks === 3) {
    activateSansMegalovania();
  } else {
    createConfetti(20);
  }
});

function activateSansMegalovania() {
  state.rainbowMode = true;
  document.body.classList.add('rainbow-mode');
  socksMsg.innerHTML = 'üíÄ YOU\'RE GONNA HAVE A BAD TIME üíÄ';
  socksMsg.classList.add('active');
  createConfetti(200);
  setTimeout(() => {
    socksMsg.classList.remove('active');
    showToast('...but nobody came.', 3000);
  }, 3000);
  setTimeout(() => {
    document.body.classList.remove('rainbow-mode');
    state.rainbowMode = false;
    state.sansClicks = 0;
    sansCounter.classList.remove('show');
  }, 10000);
}

function createConfetti(count) {
  const colors = ['#ff0000', '#ffff00', '#0000ff', '#ff5aab', '#00ff00'];
  for(let i = 0; i < count; i++) {
    const conf = document.createElement('div');
    conf.className = 'confetti';
    conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    conf.style.width = conf.style.height = Math.random() * 10 + 5 + 'px';
    conf.style.animationName = i % 2 === 0 ? 'fall-left' : 'fall-right';
    conf.style.animationDelay = Math.random() * 0.5 + 's';
    confettiContainer.appendChild(conf);
    conf.addEventListener('animationend', () => conf.remove());
  }
}

function activateSocksMode() {
  if(state.socksMode) return;
  state.socksMode = true;
  document.body.classList.add('socks-mode');
  socksMsg.innerHTML = 'üß¶ SOCKS MODE ACTIVATED! üß¶<br><small style="font-size:1.5rem;">now you\'re one of us... uwu</small>';
  socksMsg.classList.add('active');
  createConfetti(150);
  setTimeout(() => { socksMsg.classList.remove('active'); }, 3000);
  showToast('Socks mode –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! üß¶‚ú®', 3000);
}

const toastContainer = document.getElementById('toast-container');
function showToast(msg, ms = 2600) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, ms);
}

function generateKeyPair() {
  const kp = nacl.box.keyPair();
  state.myKeyPair = { publicKey: kp.publicKey, secretKey: kp.secretKey };
  return nacl.util.encodeBase64(kp.publicKey);
}

async function sha256hex(u8) {
  if(!crypto.subtle) return 'N/A';
  try {
    const hash = await crypto.subtle.digest('SHA-256', u8);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch(e) { return 'Error'; }
}

function encryptMessage(text) {
  const nonce = nacl.randomBytes(24);
  const encoder = new TextEncoder();
  const msgU8 = encoder.encode(text);
  const box = nacl.box(msgU8, nonce, state.peerPublicKey, state.myKeyPair.secretKey);
  return nacl.util.encodeBase64(nonce) + ':' + nacl.util.encodeBase64(box);
}

function decryptMessage(ciphertext) {
  const parts = ciphertext.split(':');
  if(parts.length !== 2) throw new Error('Invalid format');
  const nonce = nacl.util.decodeBase64(parts[0]);
  const ct = nacl.util.decodeBase64(parts[1]);
  const msgU8 = nacl.box.open(ct, nonce, state.peerPublicKey, state.myKeyPair.secretKey);
  if(!msgU8) throw new Error('Decryption failed');
  const decoder = new TextDecoder();
  return decoder.decode(msgU8);
}

const chatStatus = document.getElementById('chat-status');
const chatMessages = document.getElementById('chat-messages');
const chatInputArea = document.getElementById('chat-input-area');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');
const roomSetup = document.getElementById('room-setup');
const roomCodeDisplay = document.getElementById('room-code-display');
const createRoomBtn = document.getElementById('create-room-btn');
const joinRoomBtn = document.getElementById('join-room-btn');
const joinRoomInput = document.getElementById('join-room-input');
const typingIndicator = document.getElementById('typing-indicator');

let typingTimeout = null;

chatInput.addEventListener('input', () => {
  if(!state.roomId) return;
  const text = chatInput.value.toLowerCase().trim();
  if (text === '–∏–≥—Ä–∞—Ç—å') {
    startGameInvitation();
    return;
  }
  set(ref(db, `rooms/${state.roomId}/typing/${state.userId}`), true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    set(ref(db, `rooms/${state.roomId}/typing/${state.userId}`), false);
  }, 2000);
});

function generateRoomCode() {
  return 'HAX-' + Math.random().toString(36).substr(2, 6).toUpperCase();
}

// ============ GAME SYSTEM ============
function startGameInvitation() {
  if (state.gameState.active) { showToast('–ò–≥—Ä–∞ —É–∂–µ –∏–¥—ë—Ç!'); return; }
  state.gameState.active = true;
  state.gameState.isHost = true;
  state.gameState.waitingForAccept = true;
  state.gameState.round = 1;
  state.gameState.myScore = 0;
  state.gameState.opponentScore = 0;
  set(ref(db, `rooms/${state.roomId}/game/invitation`), { from: state.userId, timestamp: Date.now() });
  showGameModal('–û–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∏–≥—Ä—ã...', 'accept');
  showToast('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ñ–¥—ë–º –æ—Ç–≤–µ—Ç... üéÆ');
}

function showGameModal(statusText, mode = 'choices') {
  const modal = document.getElementById('game-modal');
  const status = document.getElementById('game-status');
  const choices = document.getElementById('game-choices');
  const acceptBtn = document.getElementById('accept-game-btn');
  const declineBtn = document.getElementById('decline-game-btn');
  const playAgainBtn = document.getElementById('play-again-btn');
  const timerBar = document.getElementById('timer-bar');
  
  status.textContent = statusText;
  modal.classList.add('active');
  choices.style.display = 'none';
  acceptBtn.style.display = 'none';
  declineBtn.style.display = 'none';
  playAgainBtn.style.display = 'none';
  timerBar.style.width = '100%';
  
  if (mode === 'accept') {
    acceptBtn.style.display = 'inline-block';
    declineBtn.style.display = 'inline-block';
  } else if (mode === 'choices') {
    choices.style.display = 'flex';
  } else if (mode === 'result') {
    playAgainBtn.style.display = 'inline-block';
  }
}

function closeGameModal() {
  const modal = document.getElementById('game-modal');
  modal.classList.remove('active');
  if (state.gameState.timer) { clearInterval(state.gameState.timer); }
}

function makeChoice(choice) {
  if (!state.gameState.active || !state.gameState.waitingForChoice) return;
  state.gameState.myChoice = choice;
  state.gameState.waitingForChoice = false;
  document.querySelectorAll('.choice-btn').forEach(btn => { btn.disabled = true; });
  set(ref(db, `rooms/${state.roomId}/game/choice/${state.userId}`), { choice: choice, timestamp: Date.now() });
  showToast(`–í—ã –≤—ã–±—Ä–∞–ª–∏: ${getChoiceName(choice)} ‚úä`);
}

function getChoiceName(choice) {
  const names = { 'rock': 'ü™® –ö–∞–º–µ–Ω—å', 'paper': 'üìÑ –ë—É–º–∞–≥–∞', 'scissors': '‚úÇÔ∏è –ù–æ–∂–Ω–∏—Ü—ã' };
  return names[choice] || choice;
}

function determineWinner(choice1, choice2) {
  if (choice1 === choice2) return 'tie';
  const wins = { 'rock': 'scissors', 'scissors': 'paper', 'paper': 'rock' };
  if (wins[choice1] === choice2) return 'player1';
  return 'player2';
}

function startTimer() {
  state.gameState.timeLeft = 10;
  const timerBar = document.getElementById('timer-bar');
  const timerCount = document.getElementById('timer-count');
  state.gameState.timer = setInterval(() => {
    state.gameState.timeLeft--;
    timerCount.textContent = state.gameState.timeLeft;
    timerBar.style.width = (state.gameState.timeLeft * 10) + '%';
    if (state.gameState.timeLeft <= 0) {
      clearInterval(state.gameState.timer);
      const choices = ['rock', 'paper', 'scissors'];
      const randomChoice = choices[Math.floor(Math.random() * 3)];
      makeChoice(randomChoice);
    }
  }, 1000);
}

function updateGameUI() {
  document.getElementById('current-round').textContent = state.gameState.round;
  document.getElementById('my-score').textContent = `–í–∞—à —Å—á—ë—Ç: ${state.gameState.myScore}`;
  document.getElementById('opponent-score').textContent = `–°—á—ë—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞: ${state.gameState.opponentScore}`;
}

function handleGameInvitation(fromUser) {
  if (state.gameState.active) return;
  state.gameState.active = true;
  state.gameState.isHost = false;
  state.gameState.waitingForAccept = true;
  showGameModal(`${fromUser} –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –≤–∞—Å —Å—ã–≥—Ä–∞—Ç—å –≤ –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞!`, 'accept');
  showToast('–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∏–≥—Ä—É! üéÆ');
}

function setupGameListeners() {
  if (!state.roomId) return;
  onValue(ref(db, `rooms/${state.roomId}/game/invitation`), (snapshot) => {
    if (snapshot.exists() && !state.gameState.active) {
      const invitation = snapshot.val();
      if (invitation.from !== state.userId) { handleGameInvitation(invitation.from); }
    }
  });
  onValue(ref(db, `rooms/${state.roomId}/game/response`), (snapshot) => {
    if (snapshot.exists()) {
      const response = snapshot.val();
      if (response.from !== state.userId) {
        if (response.accepted) { startGame(); }
        else {
          closeGameModal();
          state.gameState.active = false;
          showToast('–ò–≥—Ä–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ üòî');
        }
      }
    }
  });
  onValue(ref(db, `rooms/${state.roomId}/game/choice`), (snapshot) => {
    if (snapshot.exists()) {
      const choices = snapshot.val();
      const players = Object.keys(choices);
      if (players.length === 2) {
        const player1Choice = choices[players[0]].choice;
        const player2Choice = choices[players[1]].choice;
        setTimeout(() => { processRoundResult(player1Choice, player2Choice); }, 1000);
      }
    }
  });
}

function acceptGame() {
  state.gameState.waitingForAccept = false;
  set(ref(db, `rooms/${state.roomId}/game/response`), { from: state.userId, accepted: true, timestamp: Date.now() });
  showToast('–ò–≥—Ä–∞ –ø—Ä–∏–Ω—è—Ç–∞! üéâ');
  startGame();
}

function declineGame() {
  set(ref(db, `rooms/${state.roomId}/game/response`), { from: state.userId, accepted: false, timestamp: Date.now() });
  closeGameModal();
  state.gameState.active = false;
}

function startGame() {
  state.gameState.round = 1;
  state.gameState.myScore = 0;
  state.gameState.opponentScore = 0;
  state.gameState.myChoice = null;
  state.gameState.opponentChoice = null;
  updateGameUI();
  showGameModal('–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –°–¥–µ–ª–∞–π—Ç–µ –≤–∞—à –≤—ã–±–æ—Ä:', 'choices');
  document.querySelectorAll('.choice-btn').forEach(btn => { btn.disabled = false; });
  state.gameState.waitingForChoice = true;
  startTimer();
}

function processRoundResult(choice1, choice2) {
  const player1Choice = state.gameState.isHost ? choice1 : choice2;
  const player2Choice = state.gameState.isHost ? choice2 : choice1;
  const winner = determineWinner(player1Choice, player2Choice);
  let resultText = '';
  if (winner === 'tie') { resultText = `–ù–∏—á—å—è! ${getChoiceName(player1Choice)} = ${getChoiceName(player2Choice)}`; }
  else if (winner === 'player1') {
    state.gameState.myScore++;
    resultText = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —Ä–∞—É–Ω–¥! ${getChoiceName(player1Choice)} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${getChoiceName(player2Choice)}`;
  } else {
    state.gameState.opponentScore++;
    resultText = `–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ —Ä–∞—É–Ω–¥! ${getChoiceName(player2Choice)} –ø–æ–±–µ–∂–¥–∞–µ—Ç ${getChoiceName(player1Choice)}`;
  }
  updateGameUI();
  showGameModal(resultText, 'result');
  set(ref(db, `rooms/${state.roomId}/game/choice`), null);
  if (state.gameState.round >= 3) { setTimeout(() => { endGame(); }, 2000); }
  else { setTimeout(() => { nextRound(); }, 2000); }
}

function nextRound() {
  state.gameState.round++;
  state.gameState.myChoice = null;
  state.gameState.opponentChoice = null;
  updateGameUI();
  showGameModal(`–†–∞—É–Ω–¥ ${state.gameState.round}! –°–¥–µ–ª–∞–π—Ç–µ –≤–∞—à –≤—ã–±–æ—Ä:`, 'choices');
  document.querySelectorAll('.choice-btn').forEach(btn => { btn.disabled = false; });
  state.gameState.waitingForChoice = true;
  startTimer();
}

function endGame() {
  let finalResult = '';
  if (state.gameState.myScore > state.gameState.opponentScore) {
    finalResult = `üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ –∏–≥—Ä—É ${state.gameState.myScore}:${state.gameState.opponentScore}!`;
    createConfetti(100);
  } else if (state.gameState.myScore < state.gameState.opponentScore) {
    finalResult = `üòî –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ –∏–≥—Ä—É ${state.gameState.myScore}:${state.gameState.opponentScore}.`;
  } else {
    finalResult = `ü§ù –ù–∏—á—å—è! ${state.gameState.myScore}:${state.gameState.opponentScore}`;
  }
  showGameModal(finalResult, 'result');
  showToast('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
  setTimeout(() => {
    closeGameModal();
    state.gameState.active = false;
    set(ref(db, `rooms/${state.roomId}/game`), null);
  }, 5000);
}

function playAgain() { startGameInvitation(); }

document.getElementById('accept-game-btn').addEventListener('click', acceptGame);
document.getElementById('decline-game-btn').addEventListener('click', declineGame);
document.getElementById('play-again-btn').addEventListener('click', playAgain);

createRoomBtn.addEventListener('click', async () => {
  try {
    const roomCode = generateRoomCode();
    state.roomId = roomCode;
    state.isHost = true;
    const pubKey = generateKeyPair();
    const roomRef = ref(db, `rooms/${roomCode}`);
    await set(roomRef, {
      created: serverTimestamp(),
      host: { userId: state.userId, publicKey: pubKey, online: true },
      sessionStart: Date.now()
    });
    roomCodeDisplay.textContent = roomCode;
    roomCodeDisplay.style.display = 'block';
    roomCodeDisplay.onclick = () => {
      navigator.clipboard.writeText(roomCode);
      showToast('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! üìã');
      createConfetti(20);
    };
    chatStatus.textContent = '‚è≥ –û–∂–∏–¥–∞–µ—Ç—Å—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫...';
    showToast('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ö–æ–¥: ' + roomCode);
    onValue(ref(db, `rooms/${roomCode}/guest`), (snapshot) => {
      if(snapshot.exists()) {
        const guest = snapshot.val();
        state.peerPublicKey = nacl.util.decodeBase64(guest.publicKey);
        state.peerOnline = guest.online !== false;
        state.peerLeft = !guest.online;
        chatStatus.textContent = state.peerOnline ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ß–∞—Ç –Ω–∞—á–∞—Ç!' : 'üî¥ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ñ–ª–∞–π–Ω';
        showToast('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è! üéâ');
        createConfetti(50);
        showRoomStatus();
        startChat();
        onValue(ref(db, `rooms/${roomCode}/guest/online`), (onlineSnapshot) => {
          state.peerOnline = onlineSnapshot.val() !== false;
          state.peerLeft = !state.peerOnline;
          if (!state.peerOnline) {
            chatStatus.textContent = 'üî¥ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ñ–ª–∞–π–Ω';
            showToast('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç', 4000);
            createConfetti(30);
          } else {
            chatStatus.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ß–∞—Ç –Ω–∞—á–∞—Ç!';
          }
          showRoomStatus();
        });
      }
    });
  } catch(e) { console.error(e); showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + e.message); }
});

joinRoomBtn.addEventListener('click', async () => {
  const roomCode = joinRoomInput.value.trim().toUpperCase();
  if(!roomCode) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!'); return; }
  try {
    state.roomId = roomCode;
    state.isHost = false;
    const pubKey = generateKeyPair();
    const roomRef = ref(db, `rooms/${roomCode}`);
    onValue(roomRef, async (snapshot) => {
      if(!snapshot.exists()) { showToast('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!'); return; }
      const room = snapshot.val();
      if(room.host && room.host.publicKey) {
        state.peerPublicKey = nacl.util.decodeBase64(room.host.publicKey);
        state.peerOnline = room.host.online !== false;
        state.peerLeft = !room.host.online;
        await set(ref(db, `rooms/${roomCode}/guest`), { userId: state.userId, publicKey: pubKey, online: true });
        chatStatus.textContent = state.peerOnline ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ß–∞—Ç –Ω–∞—á–∞—Ç!' : 'üî¥ –•–æ—Å—Ç –æ—Ñ–ª–∞–π–Ω';
        showToast('–ü–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ! üéâ');
        createConfetti(50);
        showRoomStatus();
        startChat();
        onValue(ref(db, `rooms/${roomCode}/host/online`), (onlineSnapshot) => {
          state.peerOnline = onlineSnapshot.val() !== false;
          state.peerLeft = !state.peerOnline;
          if (!state.peerOnline) {
            chatStatus.textContent = 'üî¥ –•–æ—Å—Ç –æ—Ñ–ª–∞–π–Ω';
            showToast('–•–æ—Å—Ç –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç', 4000);
            createConfetti(30);
          } else {
            chatStatus.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ß–∞—Ç –Ω–∞—á–∞—Ç!';
          }
          showRoomStatus();
        });
      }
    }, { onlyOnce: true });
  } catch(e) { console.error(e); showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message); }
});

function startChat() {
  roomSetup.style.display = 'none';
  chatMessages.style.display = 'flex';
  chatInputArea.style.display = 'flex';
  showRoomStatus();
  setupOnlineStatusTracking();
  listenForCallSignals(); // <-- –ê–∫—Ç–∏–≤–∞—Ü–∏—è WebRTC
  
  const typingRef = ref(db, `rooms/${state.roomId}/typing`);
  onValue(typingRef, (snapshot) => {
    if(snapshot.exists()) {
      const typing = snapshot.val();
      const otherUserTyping = Object.keys(typing).some(uid => uid !== state.userId && typing[uid] === true);
      if(otherUserTyping) {
        typingIndicator.classList.add('show');
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } else { typingIndicator.classList.remove('show'); }
    }
  });
  
  const messagesRef = ref(db, `rooms/${state.roomId}/messages`);
  onValue(messagesRef, (snapshot) => {
    const messages = chatMessages.querySelectorAll('.message');
    messages.forEach(m => m.remove());
    if(snapshot.exists()) {
      const messagesList = [];
      snapshot.forEach((child) => { messagesList.push({ id: child.key, ...child.val() }); });
      messagesList.sort((a, b) => a.timestamp - b.timestamp);
      messagesList.forEach(msg => {
        if (msg.sender !== state.userId && state.peerPublicKey) {
          try {
            const decrypted = decryptMessage(msg.ciphertext);
            if(decrypted.toLowerCase().includes('socks') || decrypted.toLowerCase().includes('–Ω–æ—Å–∫–∏')) { activateSocksMode(); }
            if (msg.sender !== state.userId && decrypted.toLowerCase().includes('–∏–≥—Ä–∞—Ç—å')) { handleGameInvitation(msg.sender); }
            displayMessage(decrypted, msg.sender === state.userId);
          } catch(e) {}
        } else if (msg.sender === state.userId) {
          try {
            const decrypted = decryptMessage(msg.ciphertext);
            displayMessage(decrypted, true);
          } catch(e) {}
        }
      });
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
  setupGameListeners();
}

function setupOnlineStatusTracking() {
  if (!state.roomId) return;
  const userPath = state.isHost ? 'host' : 'guest';
  onDisconnect(ref(db, `rooms/${state.roomId}/${userPath}/online`)).set(false);
  const peerPath = state.isHost ? 'guest' : 'host';
  onValue(ref(db, `rooms/${state.roomId}/${peerPath}/online`), (snapshot) => {
    const isOnline = snapshot.val() !== false;
    state.peerOnline = isOnline;
    state.peerLeft = !isOnline;
    chatStatus.textContent = isOnline ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ! –ß–∞—Ç –Ω–∞—á–∞—Ç!' : 'üî¥ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ñ–ª–∞–π–Ω';
    showRoomStatus();
    if (!isOnline) { showToast('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç', 4000); }
  });
}

function displayMessage(text, isSent) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message ' + (isSent ? 'sent' : 'received');
  if (text.startsWith('[VOICE]:')) {
    const base64Audio = text.substring(8);
    const playerId = 'voice-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    const bars = Array.from({length: 25}, () => {
      const height = 8 + Math.random() * 20;
      return `<div class="voice-wave-bar" style="height: ${height}px;"></div>`;
    }).join('');
    msgDiv.innerHTML = `
      <div class="voice-player" data-player-id="${playerId}">
        <button class="voice-play-btn" data-action="play">‚ñ∂Ô∏è</button>
        <div class="voice-waveform">${bars}</div>
        <div class="voice-duration">0:00</div>
        <audio data-voice-audio="${playerId}"><source src="${base64Audio}" type="audio/webm"></audio>
      </div>
      <div class="message-time">${new Date().toLocaleTimeString()}</div>
    `;
    setTimeout(() => setupVoicePlayer(playerId), 0);
  } else {
    msgDiv.innerHTML = `<div>${text}</div><div class="message-time">${new Date().toLocaleTimeString()}</div>`;
  }
  chatMessages.appendChild(msgDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function setupVoicePlayer(playerId) {
  const player = document.querySelector(`[data-player-id="${playerId}"]`);
  if (!player) return;
  const audio = player.querySelector(`[data-voice-audio="${playerId}"]`);
  const playBtn = player.querySelector('.voice-play-btn');
  const durationEl = player.querySelector('.voice-duration');
  const waveBars = player.querySelectorAll('.voice-wave-bar');
  let isPlaying = false;
  let animationFrame = null;
  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };
  const updateWaveform = () => {
    if (!isPlaying || !audio.duration) return;
    const progress = audio.currentTime / audio.duration;
    const activeBarCount = Math.floor(waveBars.length * progress);
    waveBars.forEach((bar, index) => {
      if (index < activeBarCount) { bar.classList.add('active'); }
      else { bar.classList.remove('active'); }
    });
    if (isPlaying) { animationFrame = requestAnimationFrame(updateWaveform); }
  };
  playBtn.addEventListener('click', () => {
    if (isPlaying) {
      audio.pause();
      playBtn.textContent = '‚ñ∂Ô∏è';
      isPlaying = false;
      if (animationFrame) cancelAnimationFrame(animationFrame);
    } else {
      document.querySelectorAll('[data-voice-audio]').forEach(otherAudio => {
        if (otherAudio !== audio && !otherAudio.paused) {
          otherAudio.pause();
          const otherPlayer = otherAudio.closest('.voice-player');
          if (otherPlayer) {
            otherPlayer.querySelector('.voice-play-btn').textContent = '‚ñ∂Ô∏è';
            otherPlayer.querySelectorAll('.voice-wave-bar').forEach(bar => bar.classList.remove('active'));
          }
        }
      });
      audio.play();
      playBtn.textContent = '‚è∏Ô∏è';
      isPlaying = true;
      updateWaveform();
    }
  });
  audio.addEventListener('loadedmetadata', () => { durationEl.textContent = formatTime(audio.duration); });
  audio.addEventListener('timeupdate', () => { durationEl.textContent = formatTime(audio.currentTime); });
  audio.addEventListener('ended', () => {
    playBtn.textContent = '‚ñ∂Ô∏è';
    isPlaying = false;
    waveBars.forEach(bar => bar.classList.remove('active'));
    durationEl.textContent = formatTime(audio.duration);
    if (animationFrame) cancelAnimationFrame(animationFrame);
  });
  audio.addEventListener('contextmenu', (e) => e.preventDefault());
}

sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keydown', (e) => {
  if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

async function sendMessage() {
  const text = chatInput.value.trim();
  if(!text) return;
  try {
    await set(ref(db, `rooms/${state.roomId}/typing/${state.userId}`), false);
    const encrypted = encryptMessage(text);
    const messageRef = push(ref(db, `rooms/${state.roomId}/messages`));
    await set(messageRef, { sender: state.userId, ciphertext: encrypted, timestamp: serverTimestamp() });
    chatInput.value = '';
  } catch(e) { console.error(e); showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message); }
}

document.getElementById('manual-gen').addEventListener('click', () => {
  const pubKey = generateKeyPair();
  document.getElementById('pub-key-display').value = pubKey;
  document.getElementById('key-info').style.display = 'block';
  sha256hex(state.myKeyPair.publicKey).then(fp => { document.getElementById('key-fp').textContent = fp.slice(0, 32); });
  showToast('–ö–ª—é—á–∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã! üîë');
  createConfetti(30);
});

async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
      registration.addEventListener('updatefound', () => {
        const newWorker = registration.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            showToast('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 5000);
          }
        });
      });
    } catch (error) { console.log('‚ùå –û—à–∏–±–∫–∞ SW:', error); }
  }
}

function setupKeyboardOptimization() {
  const chatInput = document.getElementById('chat-input');
  if (!chatInput) return;
  chatInput.addEventListener('focus', () => {
    setTimeout(() => { chatInput.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' }); }, 300);
  });
  chatInput.addEventListener('focus', () => {
    if (state.isMobile) {
      document.body.classList.add('keyboard-open');
      document.documentElement.style.setProperty('--keyboard-height', '300px');
    }
  });
  chatInput.addEventListener('blur', () => {
    if (state.isMobile) {
      document.body.classList.remove('keyboard-open');
      document.documentElement.style.setProperty('--keyboard-height', '0px');
    }
  });
  chatInput.addEventListener('touchstart', () => {
    document.body.style.zoom = '1';
    setTimeout(() => { document.body.style.zoom = ''; }, 500);
  });
}

function setupTouchOptimizations() {
  document.addEventListener('contextmenu', (e) => { if (state.isMobile) { e.preventDefault(); } });
  document.addEventListener('touchstart', (e) => {
    const target = e.target.closest('button, .btn, [role="button"]');
    if (target) { target.classList.add('touch-active'); }
  }, { passive: true });
  document.addEventListener('touchend', (e) => {
    const target = e.target.closest('button, .btn, [role="button"]');
    if (target) { setTimeout(() => { target.classList.remove('touch-active'); }, 150); }
  }, { passive: true });
  if (state.isMobile) {
    let startY = 0;
    document.addEventListener('touchstart', (e) => { startY = e.touches[0].clientY; });
    document.addEventListener('touchmove', (e) => {
      const currentY = e.touches[0].clientY;
      const scrollTop = window.pageYOffset;
      if (scrollTop <= 0 && currentY > startY && state.activePage === 'chat') { e.preventDefault(); }
    });
  }
}

function setupOrientationHandler() {
  window.addEventListener('orientationchange', () => {
    setTimeout(() => {
      checkMobile();
      const chatMessages = document.getElementById('chat-messages');
      if (chatMessages && state.activePage === 'chat') {
        chatMessages.style.maxHeight = window.innerHeight * 0.5 + 'px';
      }
    }, 500);
  });
}

function setupZoomPrevention() {
  let lastTouchEnd = 0;
  document.addEventListener('touchend', (event) => {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) { event.preventDefault(); }
    lastTouchEnd = now;
  }, false);
}

// ============ WEBRTC CALL SYSTEM ============
const videoCallBtn = document.getElementById('video-call-btn');
const callModal = document.getElementById('call-modal');
const incomingCallModal = document.getElementById('incoming-call-modal');
const remoteVideo = document.getElementById('remote-video');
const localVideo = document.getElementById('local-video');
const hangupBtn = document.getElementById('hangup-btn');
const toggleMicBtn = document.getElementById('toggle-mic-btn');
const toggleCamBtn = document.getElementById('toggle-cam-btn');
const answerCallBtn = document.getElementById('answer-call-btn');
const rejectCallBtn = document.getElementById('reject-call-btn');
const callStatusText = document.getElementById('call-status-text');

let localStream = null;
let peerConnection = null;
let callUnsubscribe = null;

const rtcConfig = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' }
  ]
};

videoCallBtn.addEventListener('click', async () => {
  if (!state.roomId || !state.peerOnline) { showToast('–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–µ –≤ —Å–µ—Ç–∏ –∏–ª–∏ –≤—ã –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ!'); return; }
  try {
    await startLocalStream();
    createPeerConnection();
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    const callRef = ref(db, `rooms/${state.roomId}/call`);
    await set(callRef, { type: 'offer', sdp: JSON.stringify(peerConnection.localDescription), caller: state.userId });
    showCallModal();
    callStatusText.textContent = "–ó–≤–æ–Ω–∏–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É...";
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–≤–æ–Ω–∫–∞:", err);
    showToast("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
  }
});

async function startLocalStream() {
  localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = localStream;
  toggleMicBtn.classList.add('active');
  toggleCamBtn.classList.add('active');
}

function createPeerConnection() {
  peerConnection = new RTCPeerConnection(rtcConfig);
  localStream.getTracks().forEach(track => { peerConnection.addTrack(track, localStream); });
  peerConnection.ontrack = (event) => {
    console.log("–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫");
    remoteVideo.srcObject = event.streams[0];
    callStatusText.style.display = 'none';
  };
  peerConnection.onicecandidate = (event) => {
    if (event.candidate) {
      const candidatesRef = push(ref(db, `rooms/${state.roomId}/call/candidates`));
      set(candidatesRef, { candidate: JSON.stringify(event.candidate), from: state.userId });
    }
  };
  peerConnection.onconnectionstatechange = () => {
    if (peerConnection.connectionState === 'disconnected') { endCall(); }
  };
}

function listenForCallSignals() {
  const callRef = ref(db, `rooms/${state.roomId}/call`);
  callUnsubscribe = onValue(callRef, async (snapshot) => {
    const data = snapshot.val();
    if (!data) return;
    if (data.type === 'offer' && data.caller !== state.userId) { showIncomingCallModal(); }
    if (data.type === 'answer' && data.caller !== state.userId && peerConnection) {
      if (!peerConnection.currentRemoteDescription) {
        const remoteDesc = new RTCSessionDescription(JSON.parse(data.sdp));
        await peerConnection.setRemoteDescription(remoteDesc);
        callStatusText.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–æ!";
      }
    }
    if (data.type === 'hangup') { endCall(false); showToast("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º"); }
  });
  const candidatesRef = ref(db, `rooms/${state.roomId}/call/candidates`);
  onValue(candidatesRef, (snapshot) => {
    snapshot.forEach((childSnapshot) => {
      const data = childSnapshot.val();
      if (peerConnection && data.from !== state.userId) {
        const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
        peerConnection.addIceCandidate(candidate).catch(e => console.error(e));
      }
    });
  });
}

answerCallBtn.addEventListener('click', async () => {
  incomingCallModal.classList.remove('active');
  showCallModal();
  callStatusText.textContent = "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...";
  try {
    await startLocalStream();
    createPeerConnection();
    const snapshot = await get(ref(db, `rooms/${state.roomId}/call`));
    if (snapshot.exists() && snapshot.val().type === 'offer') {
        const offer = JSON.parse(snapshot.val().sdp);
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        await update(ref(db, `rooms/${state.roomId}/call`), {
            type: 'answer', sdp: JSON.stringify(peerConnection.localDescription), caller: state.userId
        });
    }
  } catch (err) { console.error(err); endCall(); }
});

rejectCallBtn.addEventListener('click', () => {
  incomingCallModal.classList.remove('active');
  set(ref(db, `rooms/${state.roomId}/call`), { type: 'hangup' });
});

hangupBtn.addEventListener('click', () => {
  set(ref(db, `rooms/${state.roomId}/call`), { type: 'hangup' });
  endCall();
});

function endCall(clearDb = true) {
  if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
  if (peerConnection) { peerConnection.close(); peerConnection = null; }
  callModal.classList.remove('active');
  incomingCallModal.classList.remove('active');
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  if (clearDb && state.roomId) { set(ref(db, `rooms/${state.roomId}/call`), null); }
}

function showCallModal() { callModal.classList.add('active'); }
function showIncomingCallModal() { incomingCallModal.classList.add('active'); }

toggleMicBtn.addEventListener('click', () => {
  if (localStream) {
    const audioTrack = localStream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    toggleMicBtn.classList.toggle('active', audioTrack.enabled);
  }
});
toggleCamBtn.addEventListener('click', () => {
  if (localStream) {
    const videoTrack = localStream.getVideoTracks()[0];
    videoTrack.enabled = !videoTrack.enabled;
    toggleCamBtn.classList.toggle('active', videoTrack.enabled);
  }
});

document.addEventListener('DOMContentLoaded', function() {
  console.log('Secure Hax Messenger initialized! üí¨üîê');
  checkMobile();
  registerServiceWorker();
  setupKeyboardOptimization();
  setupTouchOptimizations();
  setupOrientationHandler();
  setupZoomPrevention();
  showPage('home');
  checkMobile();
  loadTheme();
  
  const observerOptions = { threshold: 0.1, rootMargin: '0px 0px -50px 0px' };
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('revealed');
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);
  document.querySelectorAll('.scroll-reveal, .scroll-reveal-left, .scroll-reveal-right, .scroll-reveal-scale').forEach(el => { observer.observe(el); });
  
  document.getElementById('close-game-btn').addEventListener('click', closeGameModal);
  document.querySelectorAll('.choice-btn').forEach(btn => {
    btn.addEventListener('click', function() { makeChoice(this.getAttribute('data-choice')); });
  });
  
  document.addEventListener('visibilitychange', () => {
    checkMobile();
    if (document.visibilityState === 'visible') { setTimeout(checkMobile, 100); }
  });
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    window.deferredPrompt = e;
    showToast('üì± –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω" –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!', 5000);
  });
  window.addEventListener('appinstalled', (e) => { showToast('üéâ Secure Hax Messenger —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!'); });
  window.addEventListener('beforeunload', () => {
    if (state.roomId) {
      const userPath = state.isHost ? 'host' : 'guest';
      set(ref(db, `rooms/${state.roomId}/${userPath}/online`), false);
    }
  });

  let touchStartY = 0;
  let touchStartX = 0;
  document.addEventListener('touchstart', (e) => {
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
  }, { passive: true });
  document.addEventListener('touchend', (e) => {
    const touchEndY = e.changedTouches[0].clientY;
    const touchEndX = e.changedTouches[0].clientX;
    const deltaY = touchEndY - touchStartY;
    const deltaX = touchEndX - touchStartX;
    if (Math.abs(deltaY) < 50 && Math.abs(deltaX) > 100) {
      if (deltaX > 50 && state.activePage === 'chat') { toggleMenu(); }
    }
  }, { passive: true });

  const isTouchCapable = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  if (isTouchCapable) { document.body.classList.add('touch-capable'); }
  else { document.body.classList.add('no-touch'); }

  const setCSSVariables = () => {
    const root = document.documentElement;
    root.style.setProperty('--safe-area-inset-bottom', getComputedStyle(document.body).getPropertyValue('padding-bottom'));
    root.style.setProperty('--keyboard-height', '0px');
  };
  setCSSVariables();
  window.addEventListener('resize', setCSSVariables);
});
</script>
</body>
</html>
