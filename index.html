<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secure Chat 2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: #f3f4f6;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 { margin-top: 24px; color: #111827; }
  .container { width: 90%; max-width: 700px; margin: 12px auto; }
  .card {
    background: #fff; border-radius: 12px; padding: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px;
  }
  .card h2 { margin-top:0; color: #1f2937; font-size:1.2rem; }
  textarea,input { width:100%; box-sizing:border-box; margin:6px 0; padding:8px; border-radius:6px; border:1px solid #d1d5db; font-family: monospace; font-size:0.9rem; }
  button {
    background:#3b82f6; color:#fff; border:none; border-radius:8px;
    padding:10px 16px; margin-top:6px; cursor:pointer; font-weight:600;
    transition:0.2s;
  }
  button:disabled { background:#9ca3af; cursor: not-allowed; }
  button:hover:not(:disabled) { background:#2563eb; }
  pre { background:#f9fafb; padding:8px; overflow-x:auto; border-radius:6px; font-size:0.85rem; }
  .row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .flex-col { display:flex; flex-direction:column; }
  .note { font-size:0.75rem; color:#6b7280; margin-top:4px; }
</style>
</head>
<body>
<h1>Secure Chat 2.0 üîê</h1>
<div class="container">

  <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π -->
  <div class="card">
    <h2>1Ô∏è‚É£ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É –∫–ª—é—á–µ–π</h2>
    <button id="gen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
    <div id="pubArea" style="display:none" class="flex-col">
      <label>–í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:</label>
      <textarea id="myPub" rows="3" readonly></textarea>
      <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ (SHA-256, 16 –±–∞–π—Ç hex): <code id="myFp"></code></div>
      <div class="note">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É. –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ!</div>
    </div>
  </div>

  <!-- –ò–º–ø–æ—Ä—Ç –∫–ª—é—á–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ -->
  <div class="card">
    <h2>2Ô∏è‚É£ –í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h2>
    <textarea id="peerPub" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"></textarea>
    <button id="importPeer" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: <code id="peerFp"></code></div>
    <div class="note">–°–≤–µ—Ä—å—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–æ –∑–≤–æ–Ω–∫—É/–ª–∏—á–Ω–æ.</div>
  </div>

  <!-- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ -->
  <div class="card">
    <h2>3Ô∏è‚É£ –®–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="plain" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <button id="encryptBtn" disabled>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
    <textarea id="cipherout" rows="3" readonly></textarea>
  </div>

  <!-- –î–µ—à–∏—Ñ—Ä–æ–≤–∫–∞ -->
  <div class="card">
    <h2>4Ô∏è‚É£ –î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="cipherin" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É"></textarea>
    <button id="decryptBtn" disabled>–î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</label>
    <textarea id="plainout" rows="3" readonly></textarea>
  </div>

  <div class="note">–ü—É–±–ª–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ. –í—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—è–π—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∏, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å MITM.</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
<script>
(async function(){
  const b64encode = nacl.util.encodeBase64;
  const b64decode = nacl.util.decodeBase64;
  const utf8toUint = nacl.util.decodeUTF8;
  const uintToUtf8 = nacl.util.encodeUTF8;

  let keyPair = null;
  let peerPubUint8 = null;
  let sharedKey = null;

  function toBase64(u8){ return b64encode(u8); }
  function fromBase64(s){ return b64decode(s); }

  async function sha256hex(u8){
    const hash = await crypto.subtle.digest('SHA-256', u8);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,32);
  }

  const genBtn = document.getElementById('gen');
  const importBtn = document.getElementById('importPeer');
  const encryptBtn = document.getElementById('encryptBtn');
  const decryptBtn = document.getElementById('decryptBtn');

  genBtn.onclick = async ()=>{
    keyPair = nacl.box.keyPair();
    const pubB64 = toBase64(keyPair.publicKey);
    document.getElementById('myPub').value = pubB64;
    document.getElementById('pubArea').style.display='flex';
    document.getElementById('myFp').textContent = await sha256hex(keyPair.publicKey);
    importBtn.disabled=false;
    encryptBtn.disabled=false;
    decryptBtn.disabled=false;
    alert('–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.');
  };

  importBtn.onclick = async ()=>{
    const s = document.getElementById('peerPub').value.trim();
    if(!s){ alert('–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á'); return; }
    try{
      peerPubUint8 = fromBase64(s);
      document.getElementById('peerFp').textContent = await sha256hex(peerPubUint8);
      sharedKey = nacl.box.before(peerPubUint8, keyPair.secretKey);
      alert('–ö–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω. –°–≤–µ—Ä—å—Ç–µ –æ—Ç–ø–µ—á–∞—Ç–∫–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.');
    }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª—é—á–∞: '+e); }
  };

  encryptBtn.onclick = ()=>{
    if(!sharedKey){ alert('–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞'); return; }
    const pt = document.getElementById('plain').value;
    const ptU8 = utf8toUint(pt);
    const nonce = nacl.randomBytes(24);
    const cipher = nacl.box.after(ptU8, nonce, sharedKey);
    const combined = new Uint8Array(nonce.length + cipher.length);
    combined.set(nonce,0); combined.set(cipher,nonce.length);
    document.getElementById('cipherout').value = toBase64(combined);
  };

  decryptBtn.onclick = ()=>{
    if(!sharedKey){ alert('–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞'); return; }
    const s = document.getElementById('cipherin').value.trim();
    if(!s){ alert('–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É'); return; }
    try{
      const all = fromBase64(s);
      const nonce = all.slice(0,24);
      const cipher = all.slice(24);
      const plainU8 = nacl.box.open.after(cipher, nonce, sharedKey);
      if(!plainU8){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å'); return; }
      document.getElementById('plainout').value = uintToUtf8(plainU8);
    }catch(e){ alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–µ: '+e); }
  };
})();
</script>
</body>
</html>