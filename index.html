<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secure Chat 2.0 üîê</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #2c003e, #5a006a, #ff5aab);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #f5f5f5;
  margin:0; padding:0;
}
h1 { margin-top: 24px; font-size: 2rem; color: #ffd6f7; text-shadow: 0 2px 8px rgba(0,0,0,0.5);}
.container { width: 90%; max-width: 700px; margin: 16px auto;}
.card { background: rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); backdrop-filter: blur(10px); transition: transform 0.2s, box-shadow 0.2s;}
.card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.6);}
textarea, input { width: 100%; box-sizing: border-box; margin: 6px 0; padding: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: #fff; font-family: monospace; font-size: 0.95rem;}
button { background: linear-gradient(90deg, #ff5aab, #8a2be2); color: #fff; border: none; border-radius: 12px; padding: 12px 18px; margin-top: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.3s, filter 0.2s;}
button:hover { background: linear-gradient(90deg, #ff75c4, #a64ddb); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); filter: brightness(1.1);}
button:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(0,0,0,0.4);}
pre { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; overflow-x: auto; font-size: 0.85rem; color: #fff;}
.row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.flex-col { display:flex; flex-direction:column;}
#toast-container { position: fixed; top:20px; right:20px; z-index:9999;}
.toast { background: rgba(255,255,255,0.2); color: #fff; padding: 10px 16px; margin-top: 8px; border-radius: 10px; box-shadow:0 4px 12px rgba(0,0,0,0.5); backdrop-filter: blur(5px); font-weight:500; transition: opacity 0.3s ease, transform 0.3s ease; opacity:0; transform: translateY(-20px);}
</style>
</head>
<body>

<h1>Secure Chat 2.0 üîê</h1>
<div class="container">

  <div class="card">
    <h2>1Ô∏è‚É£ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É –∫–ª—é—á–µ–π</h2>
    <button id="gen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
    <div id="pubArea" style="display:none" class="flex-col">
      <label>–í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:</label>
      <textarea id="myPub" rows="3" readonly></textarea>
      <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ (SHA-256, 16 –±–∞–π—Ç hex): <code id="myFp"></code></div>
    </div>
  </div>

  <div class="card">
    <h2>2Ô∏è‚É£ –í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h2>
    <textarea id="peerPub" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"></textarea>
    <button id="importPeer" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: <code id="peerFp"></code></div>
  </div>

  <div class="card">
    <h2>3Ô∏è‚É£ –®–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="plain" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <button id="encryptBtn" disabled>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
    <textarea id="cipherout" rows="3" readonly></textarea>
  </div>

  <div class="card">
    <h2>4Ô∏è‚É£ –î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="cipherin" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É"></textarea>
    <button id="decryptBtn" disabled>–î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</label>
    <textarea id="plainout" rows="3" readonly></textarea>
  </div>

</div>

<div id="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
<script>
(async function(){
  const b64encode = nacl.util.encodeBase64;
  const b64decode = nacl.util.decodeBase64;
  const utf8toUint = nacl.util.decodeUTF8;
  const uintToUtf8 = nacl.util.encodeUTF8;

  let keyPair = null;
  let peerPubUint8 = null;

  function toBase64(u8){ return b64encode(u8); }
  function fromBase64(s){ return b64decode(s); }

  async function sha256hex(u8){
    const hash = await crypto.subtle.digest('SHA-256', u8);
    return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,32);
  }

  function showToast(message, duration = 3000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    container.appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      toast.addEventListener('transitionend', () => { toast.remove(); });
    }, duration);
  }

  const genBtn = document.getElementById('gen');
  const importBtn = document.getElementById('importPeer');
  const encryptBtn = document.getElementById('encryptBtn');
  const decryptBtn = document.getElementById('decryptBtn');

  genBtn.onclick = async ()=>{
    keyPair = nacl.box.keyPair();
    const pubB64 = toBase64(keyPair.publicKey);
    document.getElementById('myPub').value = pubB64;
    document.getElementById('pubArea').style.display='flex';
    document.getElementById('myFp').textContent = await sha256hex(keyPair.publicKey);
    importBtn.disabled=false;
    encryptBtn.disabled=false;
    decryptBtn.disabled=false;
    showToast('–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
  };

  importBtn.onclick = async ()=>{
    const s = document.getElementById('peerPub').value.trim();
    if(!s){ showToast('–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á!'); return; }
    try{
      peerPubUint8 = fromBase64(s);
      document.getElementById('peerFp').textContent = await sha256hex(peerPubUint8);
      document.getElementById('peerPub').value=''; // –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞
      showToast('–ö–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
    } catch(e){ showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á!'); }
  };

  encryptBtn.onclick = ()=>{
    const text = document.getElementById('plain').value.trim();
    if(!text){ showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!'); return; }
    const nonce = nacl.randomBytes(24);
    const encrypted = nacl.box(utf8toUint(text), nonce, peerPubUint8, keyPair.secretKey);
    document.getElementById('cipherout').value = toBase64(nonce)+':'+toBase64(encrypted);
    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!');
    document.getElementById('plain').value=''; // –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
  };

  decryptBtn.onclick = ()=>{
    const data = document.getElementById('cipherin').value.trim();
    if(!data){ showToast('–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!'); return; }
    try{
      const [nonceB64, msgB64] = data.split(':');
      const decrypted = nacl.box.open(fromBase64(msgB64), fromBase64(nonceB64), peerPubUint8, keyPair.secretKey);
      if(!decrypted) throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏');
      document.getElementById('plainout').value = uintToUtf8(decrypted);
      document.getElementById('cipherin').value=''; // –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è
      showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!');
    } catch(e){
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å!');
    }
  };

})();
</script>

</body>
</html>
