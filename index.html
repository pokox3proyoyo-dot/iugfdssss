<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Secure Chat 2.0 üîê</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #2c003e, #5a006a, #ff5aab);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  color: #f5f5f5;
  margin:0; padding:0;
}
h1 { margin-top: 24px; font-size: 2rem; color: #ffd6f7; text-shadow: 0 2px 8px rgba(0,0,0,0.5);}
.container { width: 90%; max-width: 700px; margin: 16px auto;}
.card { background: rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); backdrop-filter: blur(4px); transition: transform 0.2s, box-shadow 0.2s;}
.card:hover { transform: translateY(-2px); box-shadow: 0 12px 24px rgba(0,0,0,0.6);}
textarea, input { width: 100%; box-sizing: border-box; margin: 6px 0; padding: 10px; border-radius: 10px; border: none; background: rgba(255,255,255,0.2); color: #fff; font-family: monospace; font-size: 0.95rem;}
button { background: linear-gradient(90deg, #ff5aab, #8a2be2); color: #fff; border: none; border-radius: 12px; padding: 12px 18px; margin-top: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s, box-shadow 0.3s, filter 0.2s;}
button:hover { background: linear-gradient(90deg, #ff75c4, #a64ddb); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); filter: brightness(1.1);}
button:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(0,0,0,0.4);}
pre { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; overflow-x: auto; font-size: 0.85rem; color: #fff;}
.row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.flex-col { display:flex; flex-direction:column;}
#toast-container { position: fixed; top:20px; right:20px; z-index:9999;}
.toast { background: rgba(255,255,255,0.2); color: #fff; padding: 10px 16px; margin-top: 8px; border-radius: 10px; box-shadow:0 4px 12px rgba(0,0,0,0.5); backdrop-filter: blur(3px); font-weight:500; transition: opacity 0.3s ease, transform 0.3s ease; opacity:0; transform: translateY(-20px);}
footer { width:100%; text-align:center; margin:24px 0; }
footer img { width:32px; height:32px; transition: transform 0.2s; cursor:pointer; }
</style>
</head>
<body>

<h1>Secure Chat 2.0 üîê</h1>
<div class="container">
  <button id="resetBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>

  <div class="card">
    <h2>1Ô∏è‚É£ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—É –∫–ª—é—á–µ–π</h2>
    <button id="gen">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
    <div id="pubArea" style="display:none" class="flex-col">
      <label>–í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:</label>
      <textarea id="myPub" rows="3" readonly></textarea>
      <button id="copyPub">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
      <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ (SHA-256, 16 –±–∞–π—Ç hex): <code id="myFp"></code></div>
    </div>
  </div>

  <div class="card">
    <h2>2Ô∏è‚É£ –í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</h2>
    <textarea id="peerPub" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á"></textarea>
    <button id="importPeer" disabled>–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
    <div>–û—Ç–ø–µ—á–∞—Ç–æ–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞: <code id="peerFp"></code></div>
  </div>

  <div class="card">
    <h2>3Ô∏è‚É£ –®–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="plain" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <button id="encryptBtn" disabled>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:</label>
    <textarea id="cipherout" rows="3" readonly></textarea>
    <button id="copyCipher">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ</button>
  </div>

  <div class="card">
    <h2>4Ô∏è‚É£ –î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h2>
    <textarea id="cipherin" rows="3" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É"></textarea>
    <button id="decryptBtn" disabled>–î–µ—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
    <label>–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</label>
    <textarea id="plainout" rows="3" readonly></textarea>
  </div>

</div>

<div id="toast-container"></div>

<footer>
  <a href="https://t.me/BluzikArhimew" target="_blank">
    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg" alt="Telegram">
  </a>
</footer>

<script defer src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
<script>
(async function () {
  const elements = {
    myPub: document.getElementById('myPub'),
    pubArea: document.getElementById('pubArea'),
    myFp: document.getElementById('myFp'),
    peerPub: document.getElementById('peerPub'),
    peerFp: document.getElementById('peerFp'),
    plain: document.getElementById('plain'),
    cipherout: document.getElementById('cipherout'),
    cipherin: document.getElementById('cipherin'),
    plainout: document.getElementById('plainout'),
  };

  const genBtn = document.getElementById('gen');
  const importBtn = document.getElementById('importPeer');
  const encryptBtn = document.getElementById('encryptBtn');
  const decryptBtn = document.getElementById('decryptBtn');
  const copyPubBtn = document.getElementById('copyPub');
  const copyCipherBtn = document.getElementById('copyCipher');
  const resetBtn = document.getElementById('resetBtn');

  let keyPair = null;
  let peerPubUint8 = null;
  const MAX_LENGTH = 3000;
  const PUBLIC_KEY_LENGTH = 32;
  const NONCE_LENGTH = 24;

  function sanitizeInput(str) {
    return str.replace(/[<>&"'`]/g, (c) => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;', '`': '&#96;' })[c]);
  }

  function toBase64(u8) { return nacl.util.encodeBase64(u8); }
  function fromBase64(s) { return nacl.util.decodeBase64(s); }
  async function sha256hex(u8) {
    const hash = await crypto.subtle.digest('SHA-256', u8);
    return Array.from(new Uint8Array(hash)).map((b) => b.toString(16).padStart(2, '0')).join('').slice(0, 32);
  }

  function showToast(message, duration = 3000) {
    const container = document.getElementById('toast-container');
    if (container.children.length >= 3) container.children[0].remove();
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = sanitizeInput(message);
    container.appendChild(toast);
    requestAnimationFrame(() => {
      toast.style.opacity = '1';
      toast.style.transform = 'translateY(0)';
    });
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(-20px)';
      toast.addEventListener('transitionend', () => toast.remove());
    }, duration);
  }

  function loadKeys() {
    const savedKeyPair = localStorage.getItem('keyPair');
    if (savedKeyPair) {
      keyPair = JSON.parse(savedKeyPair);
      keyPair.publicKey = fromBase64(keyPair.publicKey);
      keyPair.secretKey = fromBase64(keyPair.secretKey);
      elements.myPub.value = toBase64(keyPair.publicKey);
      elements.pubArea.style.display = 'flex';
      sha256hex(keyPair.publicKey).then((fp) => {
        elements.myFp.textContent = fp;
      });
      importBtn.disabled = false;
      encryptBtn.disabled = false;
      decryptBtn.disabled = false;
    }
  }

  function generateKeys() {
    keyPair = nacl.box.keyPair();
    localStorage.setItem('keyPair', JSON.stringify({
      publicKey: toBase64(keyPair.publicKey),
      secretKey: toBase64(keyPair.secretKey),
    }));
    elements.myPub.value = toBase64(keyPair.publicKey);
    elements.pubArea.style.display = 'flex';
    sha256hex(keyPair.publicKey).then((fp) => {
      elements.myFp.textContent = fp;
    });
    importBtn.disabled = false;
    encryptBtn.disabled = false;
    decryptBtn.disabled = false;
    showToast('–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!');
    elements.peerPub.focus();
  }

  function importPeerKey() {
    let s = sanitizeInput(elements.peerPub.value.trim());
    if (!s) {
      showToast('–í—Å—Ç–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á!');
      return;
    }
    try {
      peerPubUint8 = fromBase64(s);
      if (peerPubUint8.length !== PUBLIC_KEY_LENGTH) {
        throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–ª—é—á–∞');
      }
      sha256hex(peerPubUint8).then((fp) => {
        elements.peerFp.textContent = fp;
      });
      elements.peerPub.value = '';
      showToast('–ö–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!');
      elements.plain.focus();
    } catch (e) {
      showToast('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á: ' + e.message);
    }
  }

  function encryptMessage() {
    let text = sanitizeInput(elements.plain.value.trim());
    if (!text) {
      showToast('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!');
      return;
    }
    if (text.length > MAX_LENGTH) {
      showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ!');
      return;
    }
    if (!peerPubUint8) {
      showToast('–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!');
      return;
    }
    const nonce = nacl.randomBytes(NONCE_LENGTH);
    const encrypted = nacl.box(nacl.util.decodeUTF8(text), nonce, peerPubUint8, keyPair.secretKey);
    elements.cipherout.value = toBase64(nonce) + ':' + toBase64(encrypted);
    showToast('–°–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!');
    elements.plain.value = '';
    elements.cipherout.focus();
  }

  function decryptMessage() {
    let data = sanitizeInput(elements.cipherin.value.trim());
    if (!data) {
      showToast('–í—Å—Ç–∞–≤—å—Ç–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!');
      return;
    }
    if (data.length > MAX_LENGTH) {
      showToast('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ!');
      return;
    }
    if (!peerPubUint8) {
      showToast('–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞!');
      return;
    }
    try {
      const [nonceB64, msgB64] = data.split(':');
      const decrypted = nacl.box.open(fromBase64(msgB64), fromBase64(nonceB64), peerPubUint8, keyPair.secretKey);
      if (!decrypted) throw new Error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏');
      elements.plainout.value = sanitizeInput(nacl.util.encodeUTF8(decrypted));
      elements.cipherin.value = '';
      showToast('–°–æ–æ–±—â–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ!');
    } catch (e) {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å: ' + e.message);
    }
  }

  function resetAll() {
    keyPair = null;
    peerPubUint8 = null;
    localStorage.removeItem('keyPair');
    elements.myPub.value = '';
    elements.pubArea.style.display = 'none';
    elements.myFp.textContent = '';
    elements.peerPub.value = '';
    elements.peerFp.textContent = '';
    elements.plain.value = '';
    elements.cipherout.value = '';
    elements.cipherin.value = '';
    elements.plainout.value = '';
    importBtn.disabled = true;
    encryptBtn.disabled = true;
    decryptBtn.disabled = true;
    showToast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!');
  }

  genBtn.onclick = generateKeys;
  importBtn.onclick = importPeerKey;
  encryptBtn.onclick = encryptMessage;
  decryptBtn.onclick = decryptMessage;
  resetBtn.onclick = resetAll;
  copyPubBtn.onclick = () => {
    navigator.clipboard.writeText(elements.myPub.value)
      .then(() => showToast('–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!'))
      .catch(() => showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!'));
  };
  copyCipherBtn.onclick = () => {
    navigator.clipboard.writeText(elements.cipherout.value)
      .then(() => showToast('–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'))
      .catch(() => showToast('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!'));
  };

  elements.peerPub.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      importPeerKey();
    }
  });
  elements.plain.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      encryptMessage();
    }
  });
  elements.cipherin.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      decryptMessage();
    }
  });

  const tgIcon = document.querySelector('footer a img');
  tgIcon.addEventListener('mouseover', () => (tgIcon.style.transform = 'scale(1.2)'));
  tgIcon.addEventListener('mouseout', () => (tgIcon.style.transform = 'scale(1)'));

  loadKeys();
})();
</script>
</body>
</html>
